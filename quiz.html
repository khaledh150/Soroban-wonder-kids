<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Soroban Canvas Quiz</title>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:#b3c4e7; font-family:sans-serif;}
    #abacusRoot { position:absolute; top:0; right:0; width:100vw; height:100vh; display:flex; justify-content:flex-end; align-items:center; background:#4d79ff; overflow:hidden; z-index:1; }
    .soroban { display:flex; justify-content:center; align-items:center; padding:5px; width:160%; height:100%; }
    .rod { position:relative; width:95px; height:390px; background:#4d79ff; border-radius:5px; display:flex; flex-direction:column; align-items:center; justify-content:space-between;}
    .rod-line { position:absolute; top:0; bottom:0; width:3px; background:#6666ff; z-index:0;}
    .heaven, .earth, .gap-space, .bar { z-index:1; }
    .heaven { display:flex; flex-direction:column; justify-content:flex-end; align-items:center; height:14%; gap:2px;}
    .gap-space { height:2%; }
    .earth { display:flex; flex-direction:column; justify-content:flex-start; align-items:center; height:53%; margin-top:3px; gap:3px;}
    .bar { position:absolute; top:27%; width:100%; height:3px; background:#6666ff;}
    .bead { width:90px; height:50px; margin:0; background:linear-gradient(to bottom, #002db3, #002080); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); box-shadow:inset -1px -1px 4px rgba(255,255,255,0.3),inset 1px 1px 4px rgba(0,0,0,0.3); transition:transform 0.2s; touch-action:none; z-index:3;}
    .bead.active { background:radial-gradient(circle at 30% 30%, #ffd700, #ffa500); box-shadow:inset -2px -2px 5px rgba(255,255,255,0.4),inset 2px 2px 5px rgba(0,0,0,0.3);}
    .bead.heaven.active { transform:translateY(100%);}
    .bead.earth.active { transform:translateY(-150%);}
    #quizPanel { position:absolute; top:0; left:0; width:clamp(260px,22vw,380px); height:100vh; background:rgba(140,166,219,0.95); color:#fff; z-index:2; display:flex; flex-direction:column; padding:1rem;}
    #topBtns { display:flex; justify-content:flex-end; align-items:center; margin-bottom:0.5rem; gap:0.5rem; }
    #topBtns button { background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer;}
    #quizContent { flex:1; display:flex; flex-direction:column; gap:1rem; overflow-y:auto; }
    .question { display:flex; align-items:center; gap:0.5rem; }
    #qNum { background:#668cff; padding:0.3rem 0.8rem; border-radius:0.3rem; font-weight:bold;}
    #qText { flex:1; display:flex; justify-content:center; align-items:center; min-height:3.4rem; font-size:2.6rem; font-weight:bold; text-align:center; letter-spacing:1px; transition:.2s; position:relative;}
    .flash-center { display:flex; align-items:center; justify-content:center; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:100%; text-align:center; z-index:2; font-size:2.8rem; font-weight:bold; color:#fff; letter-spacing:0.08em; min-width:1em;}
    .flash-center .qmark { color:#e53; font-size:1em; font-weight:bold; margin-left:0.18em; vertical-align:middle; }
    .flash-center .diff-num { color:#ffd700; }
    .flash-center .diff-op { color:#ff5757; }
    .full-question-text { font-size:2rem; color:#fff; font-weight:bold; letter-spacing:0.06em; text-align:center; width:100%; opacity:1;}
    .input-label { font-weight:bold; }
    .inputArea { display:flex; gap:0.5rem; align-items:center; }
    #answerDisplay { flex:1; background:#fff; color:#333; text-align:right; padding:0.5rem; border:2px solid #b993d6; border-radius:0.4rem; font-size:1.2rem; user-select:none;}
    #sendBtn { background:#668cff; border:none; color:#fff; padding:0.5rem 1rem; border-radius:0.4rem; font-size:1rem; cursor:pointer;}
    #sendBtn:disabled { opacity:0.6; cursor:default;}
    #numpad { display:grid; grid-template-columns:repeat(4, 1fr); gap:0.5rem;}
    #numpad button { background:#668cff; border:none; color:#fff; padding:0.6rem; border-radius:0.4rem; font-size:1.2rem; cursor:pointer;}
    #quizTimer { width:100%; text-align:center; font-weight:bold; margin:16px 0 0; align-self:center; padding-top:0px;}
    /* Settings, Results, Time Up Panels */
    #settingsPanel, #resultsPanel, #timeUpPanel { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:4; }
    .settings-card { background:#fff; border-radius:0.8rem; width:80vw; max-width:380px; padding:1rem; display:flex; flex-direction:column; gap:1rem; }
    .settings-card label { display:flex; justify-content:space-between; align-items:center; }
    .settings-card input, .settings-card select { width:5rem; padding:0.3rem; }
    .settings-actions { display:flex; justify-content:flex-end; gap:0.5rem; }
    .settings-actions button { padding:0.5rem 1rem; border:none; border-radius:0.4rem; cursor:pointer; }
    .results-card { background:#fff; border-radius:0.8rem; width:90vw; max-width:800px; padding:1rem; display:flex; flex-direction:column; align-items:center; gap:1rem; max-height:90vh; overflow-y:auto; }
    .results-row { display:flex; flex-wrap:wrap; justify-content:space-between; width:100%; }
    .result-item { flex:0 0 19%; background:rgba(200,200,200,0.3); border-radius:0.5rem; padding:0.5rem; }
    .question-text { font-weight:bold; font-size:1rem; }
    .your-answer { margin-top:0.3rem; display:flex; align-items:center; } .mark { margin-right:0.3rem; }
    .correct-answer { font-size:0.9rem; color:#444; margin-top:0.2rem; }
    #resultScore { font-size:1.3rem; font-weight:bold; }
    .results-footer { display:flex; justify-content:center; gap:1rem; width:100%; flex-wrap:wrap; }
    .results-footer button { background:#668cff; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:0.4rem; cursor:pointer; }
    .timeup-card { background:#fff; padding:2rem; border-radius:1rem; text-align:center; max-height:80vh; overflow-y:auto; }
    .timeup-card h2 { margin:0 0 1rem; } .timeup-card .results-footer { margin-top:1rem; flex-wrap:wrap; justify-content:center; }
    @media (max-width: 600px) {
      #quizPanel { width: 100vw; max-width: 100vw; min-width: 0; padding: .7rem; }
      #qText, .full-question-text, .flash-center { font-size: 2.1rem!important; }
      .results-card { width: 97vw; }
    }
  </style>
</head>
<body>
  <div id="abacusRoot"><div class="soroban" id="sorobanBoard"></div></div>
  <div id="quizPanel">
    <div id="topBtns">
      <button id="settingsBtn">⚙️</button>
      <button id="resetBtn">↻</button>
      <button id="fullscreenBtn">⛶</button>
    </div>
    <div id="quizContent">
      <div class="question">
        <div id="qNum">Q1</div>
        <div id="qText">...</div>
      </div>
      <div>
        <div class="input-label">Your Answer</div>
        <div class="inputArea">
          <div id="answerDisplay">0</div>
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
      <div id="numpad"></div>
      <div id="quizTimer">Time Left: 10:00</div>
    </div>
  </div>
  <div id="settingsPanel">
    <div class="settings-card">
      <label>Questions per set: <input type="number" id="numQuestions" min="1" max="50" value="10" /></label>
      <label>Numbers per problem: <input type="number" id="numNumbers" min="2" max="10" value="4" /></label>
      <label>
        Timer (min):
        <select id="timerSelect"></select>
      </label>
      <label><input type="checkbox" id="muteSound" /> Mute</label>
      <div class="settings-actions">
        <button id="cancelSettings">Cancel</button>
        <button id="saveSettings">Save</button>
      </div>
    </div>
  </div>
  <div id="resultsPanel">
    <div class="results-card">
      <h2>Results</h2>
      <div class="results-row" id="resultsList"></div>
      <div id="resultScore"></div>
      <div class="results-footer">
        <button id="tryAgainBtn">↺ Try Again</button>
        <button id="fullscreenBtnResults">⛶</button>
      </div>
    </div>
  </div>
  <div id="timeUpPanel">
    <div class="timeup-card">
      <h2>Time's Up!</h2>
      <div class="results-footer">
        <button id="tryAgainTimeUpBtn">↺ Try Again</button>
        <button id="fullscreenBtnTimeUp">⛶</button>
      </div>
    </div>
  </div>
  <audio id="soundOn" src="abacus sound effect 1.wav"></audio>
  <audio id="soundOff" src="abacus sound effect 2.wav"></audio>
  <script>
    // 1. Utility functions
    const $ = (s) => document.querySelector(s),
          $$ = (s) => [...document.querySelectorAll(s)];
    const DEAD_ZONE = 10,
          SHAKE_G = 16,
          HAPTIC_MS = 12;
    let mute = false;

    // 2. Soroban rendering
    const board = $("#sorobanBoard");
    function createRod() {
      const r = document.createElement("div");
      r.className = "rod";
      r.innerHTML =
        "<div class='rod-line'></div><div class='heaven'><div class='bead heaven'></div></div><div class='gap-space'></div><div class='earth'>" + '<div class="bead earth"></div>'.repeat(4) + "</div><div class='bar'></div>";
      return r;
    }
    for (let i = 0; i < 8; i++) board.appendChild(createRod());
    function clearBoard() {
      $$(".bead.active").forEach((b) => b.classList.remove("active"));
    }
    $("#resetBtn").onclick = clearBoard;
    function setBead(b, active) {
      const hv = b.classList.contains("heaven"),
            was = b.classList.contains("active");
      if (hv) b.classList.toggle("active", active);
      else {
        const cs = [...b.parentElement.children],
              idx = cs.indexOf(b);
        cs.forEach((e, i) => e.classList.toggle("active", active ? i <= idx : i < idx));
      }
      if (HAPTIC_MS) navigator.vibrate(HAPTIC_MS);
      if (!mute) {
        if (active && !was) $("#soundOn").play();
        if (!active && was) $("#soundOff").play();
      }
    }
    $$(".bead").forEach((b) =>
      b.addEventListener("pointerdown", (e) => {
        const rg = b.classList.contains("heaven") ? "heaven" : "earth",
              sy = e.clientY;
        b.setPointerCapture(e.pointerId);
        b.onpointermove = (ev) => {
          if (Math.abs(ev.clientY - sy) > DEAD_ZONE) {
            setBead(b, rg === "heaven" ? ev.clientY > sy : ev.clientY < sy);
            b.onpointermove = null;
          }
        };
        b.onpointerup = b.onpointercancel = () => {
          b.onpointermove = null;
          b.releasePointerCapture(e.pointerId);
        };
      })
    );
    if (window.DeviceMotionEvent) {
      let last = 0;
      window.addEventListener("devicemotion", (ev) => {
        const { x, y, z } = ev.accelerationIncludingGravity,
              mag = Math.hypot(x, y, z),
              now = Date.now();
        if (mag > SHAKE_G && now - last > 750) {
          clearBoard();
          last = now;
        }
      });
    }
    // Fullscreen controls
    function isFs() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }
    function toggleFs() {
      isFs() ? document.exitFullscreen() : document.documentElement.requestFullscreen();
    }
    function setFsBtn(btn) {
      btn.textContent = isFs() ? "❎" : "⛶";
    }
    $("#fullscreenBtn").onclick = () => { toggleFs(); setFsBtn($("#fullscreenBtn")); };
    $("#fullscreenBtnResults").onclick = () => { toggleFs(); setFsBtn($("#fullscreenBtnResults")); };
    $("#fullscreenBtnTimeUp").onclick = () => { toggleFs(); setFsBtn($("#fullscreenBtnTimeUp")); };
    document.addEventListener("fullscreenchange", () => {
      setFsBtn($("#fullscreenBtn"));
      setFsBtn($("#fullscreenBtnResults"));
      setFsBtn($("#fullscreenBtnTimeUp"));
    });

    // 3. CHAPTER GENERATORS
    function randomChapter1(qCount = 10, nCount = 4) {
      // Numbers: 1-5, first number can't be 5, never total = 5, never negative or >9, no (5-x) except (5-5)
      const arr = [];
      while (arr.length < qCount) {
        const nums = Array.from({length: nCount}, () => Math.floor(Math.random() * 5) + 1);
        if (nums[0] === 5) continue; // First number cannot be 5

        let steps = [`${nums[0]}`];
        let result = nums[0];
        let valid = true;
        let stageTotals = [result];

        for (let i = 1; i < nCount; i++) {
          let op = Math.random() < 0.5 ? '+' : '-';
          if (op === '-' && result === 5 && nums[i] !== 5) { valid = false; break; }
          let next;
          if (op === '+') next = result + nums[i];
          else next = result - nums[i];
          if (next < 0 || next > 9 || next === 5) { valid = false; break; }
          steps.push(`${op} ${nums[i]}`);
          result = next;
          stageTotals.push(result);
        }
        if (!valid || stageTotals.includes(5)) continue;
        arr.push({ q: steps.join(' '), a: result.toString() });
      }
      return arr;
    }
    function randomChapter2(qCount = 10, nCount = 4) {
      // Numbers: 1-9, first number can't be 5, never total = 5, never negative or >9, no (5-x) except (5-5)
      const arr = [];
      while (arr.length < qCount) {
        const nums = Array.from({length: nCount}, () => Math.floor(Math.random() * 9) + 1);
        if (nums[0] === 5) continue; // First number cannot be 5

        let steps = [`${nums[0]}`];
        let result = nums[0];
        let valid = true;
        let stageTotals = [result];

        for (let i = 1; i < nCount; i++) {
          let op = Math.random() < 0.5 ? '+' : '-';
          if (op === '-' && result === 5 && nums[i] !== 5) { valid = false; break; }
          let next;
          if (op === '+') next = result + nums[i];
          else next = result - nums[i];
          if (next < 0 || next > 9 || next === 5) { valid = false; break; }
          steps.push(`${op} ${nums[i]}`);
          result = next;
          stageTotals.push(result);
        }
        if (!valid || stageTotals.includes(5)) continue;
        arr.push({ q: steps.join(' '), a: result.toString() });
      }
      return arr;
    }

    // 4. URL params and GENERATE QUESTIONS
    const ps = new URLSearchParams(location.search);
const currentLevel = Math.max(1, Math.min(10, parseInt(ps.get('level')) || 1));
const currentChapter = Math.max(1, Math.min(18, parseInt(ps.get('chapter')) || 1));

// Helper to pick the right question generator
function getQuestions(level, chapter, nQ, nN) {
  if (level === 1) {
    return randomChapter1(nQ, nN);
  } else if (level === 2) {
    return randomChapter2(nQ, nN);
  } else {
    // You can add more levels or chapters here as needed
    return randomChapter1(nQ, nN); // Default fallback
  }
}

// Use initial settings from settings panel or defaults
let QUESTIONS = getQuestions(currentLevel, currentChapter, 
    +($("#numQuestions")?.value || 10), +($("#numNumbers")?.value || 4));

    let idx = 0, answers = [], inp = "", locked = false, ti, tl = 600;
    const qNumEl = $("#qNum"), qTextEl = $("#qText"), ansEl = $("#answerDisplay"), sendBtnEl = $("#sendBtn");
    const timerEl = $("#quizTimer"), padEl = $("#numpad");
    function updateTimer() {
      const m = String(Math.floor(tl / 60)).padStart(2, "0"), s = String(tl % 60).padStart(2, "0");
      timerEl.textContent = `Time Left: ${m}:${s}`;
    }
    function loadQuestion() {
      const q = QUESTIONS[idx];
      qNumEl.textContent = `Q${idx + 1}`;
      qTextEl.textContent = `${q.q} =`;
      inp = "";
      locked = false;
      ansEl.textContent = "0";
      sendBtnEl.disabled = true;
    }
    function startTimer() {
      clearTimeout(ti);
      updateTimer();
      ti = setTimeout(() => {
        tl--;
        if (tl <= 0) showTimeUp();
        else startTimer();
      }, 1000);
    }
    // Numpad setup
    ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "C", "BACK"].forEach((d) => {
      const b = document.createElement("button");
      b.textContent = d === "BACK" ? "⌫" : d;
      b.onclick = () => {
        if (locked) return;
        if (d === "C") inp = "";
        else if (d === "BACK") inp = inp.slice(0, -1);
        else inp += d;
        ansEl.textContent = inp || "0";
        sendBtnEl.disabled = !inp;
      };
      padEl.appendChild(b);
    });
    sendBtnEl.onclick = () => {
      if (locked || !inp) return;
      locked = true;
      answers.push({ q: QUESTIONS[idx].q, a: QUESTIONS[idx].a, u: inp });
      if (idx < QUESTIONS.length - 1) {
        idx++;
        setTimeout(loadQuestion, 200);
      } else showResults();
    };

    // Settings Handlers
    $("#settingsBtn").onclick = () => ($("#settingsPanel").style.display = "flex");
    $("#cancelSettings").onclick = () => ($("#settingsPanel").style.display = "none");
    $("#saveSettings").onclick = () => {
  const nQ = +$("#numQuestions").value, nN = +$("#numNumbers").value, tM = +$("#timerSelect").value;
  tl = tM * 60;
  mute = $("#muteSound").checked;
  QUESTIONS = getQuestions(currentLevel, currentChapter, nQ, nN);
  idx = 0; answers = [];
  loadQuestion(); startTimer();
  $("#settingsPanel").style.display = "none";
  $("#quizPanel").style.display = "flex";
  $("#resultsPanel").style.display = "none";
  $("#timeUpPanel").style.display = "none";
};

    // Results & TimeUp
    function showResults() {
      clearTimeout(ti);
      $("#quizPanel").style.display = "none";
      $("#timeUpPanel").style.display = "none";
      const rl = $("#resultsList"), rs = $("#resultScore");
      rl.innerHTML = "";
      let sc = 0;
      answers.forEach((o, i) => {
        const ok = o.u === o.a;
        if (ok) sc++;
        const el = document.createElement("div");
        el.className = "result-item";
        el.innerHTML = `<div class='question-text'>Q${i + 1}: ${o.q}</div><div class='your-answer'><span class='mark'>${ok ? "✔️" : "❌"}</span>${o.u}</div>${!ok ? `<div class='correct-answer'>Correct: ${o.a}</div>` : ""}`;
        rl.appendChild(el);
      });
      rs.textContent = `You scored ${sc}/${answers.length}`;
      $("#resultsPanel").style.display = "flex";
    }
    function showTimeUp() {
      clearTimeout(ti);
      $("#quizPanel").style.display = "none";
      $("#resultsPanel").style.display = "none";
      $("#timeUpPanel").style.display = "flex";
    }
    $("#tryAgainBtn").onclick = () => {
      $("#resultsPanel").style.display = "none";
      idx = 0;
      answers = [];
      tl = +$("#timerSelect").value * 60;
      clearTimeout(ti);
      loadQuestion();
      startTimer();
      $("#quizPanel").style.display = "flex";
    };
    $("#tryAgainTimeUpBtn").onclick = () => {
      $("#timeUpPanel").style.display = "none";
      idx = 0;
      answers = [];
      tl = +$("#timerSelect").value * 60;
      clearTimeout(ti);
      loadQuestion();
      startTimer();
      $("#quizPanel").style.display = "flex";
    };
    // Timer options
    for (let i = 1; i <= 10; i++) {
      const o = document.createElement("option");
      o.value = o.textContent = i;
      $("#timerSelect").appendChild(o);
    }
    $("#timerSelect").value = 10;
    loadQuestion();
    startTimer();
  </script>
</body>
</html>
