<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Soroban Canvas Quiz</title>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                background: #b3c4e7;
                font-family: sans-serif;
            }
            #abacusRoot {
                position: absolute;
                top: 0;
                right: 0;
                width: 100vw;
                height: 100vh;
                display: flex;
                justify-content: flex-end;
                align-items: center;
                background: #4d79ff;
                overflow: hidden;
                z-index: 1;
            }
            .soroban {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 5px;
                width: 160%;
                height: 100%;
            }
            .rod {
                position: relative;
                width: 95px;
                height: 390px;
                background: #4d79ff;
                border-radius: 5px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
            }
            .rod-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 3px;
                background: #6666ff;
                z-index: 0;
            }
            .heaven,
            .earth,
            .gap-space,
            .bar {
                z-index: 1;
            }
            .heaven {
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center;
                height: 14%;
                gap: 2px;
            }
            .gap-space {
                height: 2%;
            }
            .earth {
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                height: 53%;
                margin-top: 3px;
                gap: 3px;
            }
            .bar {
                position: absolute;
                top: 27%;
                width: 100%;
                height: 3px;
                background: #6666ff;
            }
            .bead {
                width: 90px;
                height: 50px;
                margin: 0;
                background: linear-gradient(to bottom, #002db3, #002080);
                clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
                box-shadow: inset -1px -1px 4px rgba(255, 255, 255, 0.3), inset 1px 1px 4px rgba(0, 0, 0, 0.3);
                transition: transform 0.2s;
                touch-action: none;
                z-index: 3;
            }
            .bead.active {
                background: radial-gradient(circle at 30% 30%, #ffd700, #ffa500);
                box-shadow: inset -2px -2px 5px rgba(255, 255, 255, 0.4), inset 2px 2px 5px rgba(0, 0, 0, 0.3);
            }
            .bead.heaven.active {
                transform: translateY(100%);
            }
            .bead.earth.active {
                transform: translateY(-150%);
            }
            #quizPanel {
                position: absolute;
                top: 0;
                left: 0;
                width: clamp(260px, 22vw, 380px);
                height: 100vh;
                background: rgba(140, 166, 219, 0.95);
                color: #fff;
                z-index: 2;
                display: flex;
                flex-direction: column;
                padding: 1rem;
            }
            #topBtns {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                margin-bottom: 0.5rem;
                gap: 0.5rem;
            }
            #topBtns button {
                background: transparent;
                border: none;
                color: #fff;
                font-size: 1.5rem;
                cursor: pointer;
            }
            #quizContent {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 1rem;
                overflow-y: auto;
            }
            .question {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            #qNum {
                background: #668cff;
                padding: 0.3rem 0.8rem;
                border-radius: 0.3rem;
                font-weight: bold;
            }
            #qText {
                flex: 1;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 3.4rem;
                font-size: 2.6rem;
                font-weight: bold;
                text-align: center;
                letter-spacing: 1px;
                transition: 0.2s;
                position: relative;
            }
            .flash-center {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 100%;
                text-align: center;
                z-index: 2;
                font-size: 2.8rem;
                font-weight: bold;
                color: #fff;
                letter-spacing: 0.08em;
                min-width: 1em;
            }
            .flash-center .qmark {
                color: #e53;
                font-size: 1em;
                font-weight: bold;
                margin-left: 0.18em;
                vertical-align: middle;
            }
            .flash-center .diff-num {
                color: #ffd700;
            }
            .flash-center .diff-op {
                color: #ff5757;
            }
            .full-question-text {
                font-size: 2rem;
                color: #fff;
                font-weight: bold;
                letter-spacing: 0.06em;
                text-align: center;
                width: 100%;
                opacity: 1;
            }
            .input-label {
                font-weight: bold;
            }
            .inputArea {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }
            #answerDisplay {
                flex: 1;
                background: #fff;
                color: #333;
                text-align: right;
                padding: 0.5rem;
                border: 2px solid #b993d6;
                border-radius: 0.4rem;
                font-size: 1.2rem;
                user-select: none;
            }
            #sendBtn {
                background: #668cff;
                border: none;
                color: #fff;
                padding: 0.5rem 1rem;
                border-radius: 0.4rem;
                font-size: 1rem;
                cursor: pointer;
            }
            #sendBtn:disabled {
                opacity: 0.6;
                cursor: default;
            }
            #numpad {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
            #numpad button {
                background: #668cff;
                border: none;
                color: #fff;
                padding: 0.6rem;
                border-radius: 0.4rem;
                font-size: 1.2rem;
                cursor: pointer;
            }
            #quizTimer {
                width: 100%;
                text-align: center;
                font-weight: bold;
                margin: 16px 0 0;
                align-self: center;
            }
            /* Settings, Results, Time Up Panels */
            #settingsPanel,
            #resultsPanel,
            #timeUpPanel,
            #startPanel {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.55);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 100;
            }
            .settings-card {
                background: #fff;
                border-radius: 0.8rem;
                width: 80vw;
                max-width: 380px;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .settings-card label {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .settings-card input,
            .settings-card select {
                width: 5rem;
                padding: 0.3rem;
            }
            .settings-actions {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
            }
            .settings-actions button {
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 0.4rem;
                cursor: pointer;
            }
            .results-card {
                background: #fff;
                border-radius: 0.8rem;
                width: 90vw;
                max-width: 800px;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            .results-row {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                width: 100%;
            }
            .result-item {
                flex: 0 0 19%;
                background: rgba(200, 200, 200, 0.3);
                border-radius: 0.5rem;
                padding: 0.5rem;
            }
            .question-text {
                font-weight: bold;
                font-size: 1rem;
            }
            .your-answer {
                margin-top: 0.3rem;
                display: flex;
                align-items: center;
            }
            .mark {
                margin-right: 0.3rem;
            }
            .correct-answer {
                font-size: 0.9rem;
                color: #444;
                margin-top: 0.2rem;
            }
            #resultScore {
                font-size: 1.3rem;
                font-weight: bold;
            }
            .results-footer {
                display: flex;
                justify-content: center;
                gap: 1rem;
                width: 100%;
                flex-wrap: wrap;
            }
            .results-footer button {
                background: #668cff;
                color: #fff;
                border: none;
                padding: 0.6rem 1.2rem;
                border-radius: 0.4rem;
                cursor: pointer;
            }
            .timeup-card {
                background: #fff;
                padding: 2rem;
                border-radius: 1rem;
                text-align: center;
                max-height: 80vh;
                overflow-y: auto;
            }
            .timeup-card h2 {
                margin: 0 0 1rem;
            }
            .timeup-card .results-footer {
                margin-top: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            /* Start panel styles */
            #startPanel .start-card {
                background: #fff;
                border-radius: 1.2rem;
                width: 85vw;
                max-width: 390px;
                padding: 2rem 1.2rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1.8rem;
                box-shadow: 0 8px 32px rgba(80, 110, 190, 0.12);
                animation: popin 0.6s cubic-bezier(0.51, 1.77, 0.62, 0.91);
                position: relative;
            }
            @keyframes popin {
                0% {
                    transform: scale(0.75);
                    opacity: 0;
                }
                80% {
                    transform: scale(1.05);
                    opacity: 1;
                }
                100% {
                    transform: scale(1);
                }
            }
            .abacus-mascot {
                width: 115px;
                height: 135px;
                margin-bottom: 0.2rem;
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .abacus-face {
                position: absolute;
                left: 48px;
                top: 64px;
                width: 20px;
                height: 15px;
                background: #ffe680;
                border-radius: 50% 50% 60% 60%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px #fff8, 0 0 0 3px #fff4;
            }
            .abacus-face:before {
                content: "";
                display: block;
                width: 4px;
                height: 4px;
                background: #222;
                border-radius: 50%;
                margin-right: 3px;
                margin-left: 2px;
                box-shadow: 9px 0 0 0 #222;
            }
            .abacus-body {
                width: 100%;
                height: 90px;
                position: relative;
                background: #4d79ff;
                border-radius: 22px;
                border: 3px solid #4761b8;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px #7db1ff44;
            }
            .abacus-rod {
                width: 88px;
                height: 7px;
                background: #fff;
                border-radius: 6px;
                margin: 13px auto 0 auto;
                position: relative;
                box-shadow: 0 1px 4px #fff5;
            }
            .abacus-beads {
                display: flex;
                flex-direction: row;
                gap: 12px;
                margin-top: -10px;
                margin-bottom: -5px;
                justify-content: center;
            }
            .abacus-bead {
                width: 20px;
                height: 20px;
                background: #ffd700;
                border-radius: 50%;
                border: 2px solid #ffe05b;
                margin-top: 4px;
                margin-bottom: 2px;
                box-shadow: 0 2px 6px #fff8, 0 0 0 2px #fff8;
                animation: beadbounce 1s infinite alternate cubic-bezier(0.71, 1.64, 0.51, 0.88);
            }
            .abacus-bead:nth-child(2) {
                animation-delay: 0.17s;
            }
            .abacus-bead:nth-child(3) {
                animation-delay: 0.31s;
            }
            .abacus-bead:nth-child(4) {
                animation-delay: 0.46s;
            }
            @keyframes beadbounce {
                from {
                    transform: translateY(0);
                }
                to {
                    transform: translateY(-9px);
                }
            }
            .start-title {
                font-size: 2.4rem;
                font-weight: 700;
                color: #4d79ff;
                text-shadow: 0 2px 0 #fff6, 0 0 12px #fff8;
                letter-spacing: 0.07em;
                text-align: center;
                margin: 0;
            }
            .start-btn {
                font-size: 1.4rem;
                font-weight: 700;
                padding: 1rem 2.2rem;
                background: linear-gradient(90deg, #668cff 0%, #b993d6 100%);
                color: #fff;
                border: none;
                border-radius: 0.8rem;
                cursor: pointer;
                box-shadow: 0 3px 16px #a3c6f966, 0 0 0 #fff0;
                transition: background 0.17s, transform 0.14s;
                animation: btnpulse 1.2s infinite alternate cubic-bezier(0.82, 0.13, 0.65, 1.31);
                outline: none;
            }
            @keyframes btnpulse {
                from {
                    box-shadow: 0 3px 16px #a3c6f966, 0 0 0 #fff0;
                }
                to {
                    box-shadow: 0 8px 40px #b993d6cc, 0 0 12px #668cff33;
                    transform: scale(1.035);
                }
            }
            .start-settings-btn {
                margin-top: 0.4rem;
                font-size: 1.1rem;
                color: #4d79ff;
                background: none;
                border: none;
                cursor: pointer;
                text-decoration: underline;
                font-weight: 500;
                opacity: 0.85;
                transition: opacity 0.14s;
            }
            .start-settings-btn:hover {
                opacity: 1;
            }
            .confetti {
                pointer-events: none;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                overflow: visible;
            }
            .confetti span {
                position: absolute;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                opacity: 0.78;
                animation: confetti-fall 1.4s linear forwards;
            }
            @keyframes confetti-fall {
                from {
                    transform: translateY(-40px);
                }
                to {
                    transform: translateY(340px);
                }
            }
            @media (max-width: 600px) {
                #quizPanel {
                    width: 100vw;
                    max-width: 100vw;
                    min-width: 0;
                    padding: 0.7rem;
                }
                #qText,
                .full-question-text,
                .flash-center {
                    font-size: 2.1rem !important;
                }
                .results-card {
                    width: 97vw;
                }
                #startPanel .start-card {
                    width: 99vw;
                }
            }
        </style>
    </head>
    <body>
        <!-- Start Panel -->
        <div id="startPanel">
            <div class="start-card">
                <div class="abacus-mascot">
                    <div class="abacus-body">
                        <div class="abacus-rod"></div>
                        <div class="abacus-beads">
                            <div class="abacus-bead"></div>
                            <div class="abacus-bead"></div>
                            <div class="abacus-bead"></div>
                            <div class="abacus-bead"></div>
                        </div>
                        <div class="abacus-rod"></div>
                    </div>
                    <div class="abacus-face"></div>
                </div>
                <div class="start-title">Soroban Quiz!</div>
                <button class="start-btn" id="startQuizBtn">Start Quiz!</button>
                <button class="start-settings-btn" id="startSettingsBtn">Settings ⚙️</button>
                <div class="confetti" id="confettiBox"></div>
            </div>
        </div>
        <!-- Abacus and Quiz Panel as before -->
        <div id="abacusRoot"><div class="soroban" id="sorobanBoard"></div></div>
        <div id="quizPanel" style="display: none;">
            <div id="topBtns"><button id="settingsBtn">⚙️</button><button id="resetBtn">↻</button><button id="fullscreenBtn">⛶</button></div>
            <div id="quizContent">
                <div class="question">
                    <div id="qNum">Q1</div>
                    <div id="qText"></div>
                </div>
                <div>
                    <div class="input-label">Your Answer</div>
                    <div class="inputArea">
                        <div id="answerDisplay">0</div>
                        <button id="sendBtn" disabled>Send</button>
                    </div>
                </div>
                <div id="numpad"></div>
                <div id="quizTimer">Time Left: 10:00</div>
            </div>
        </div>
        <div id="settingsPanel">
            <div class="settings-card">
                <label>Questions per set: <input type="number" id="numQuestions" min="1" max="50" value="10" /></label>
                <label>Numbers per problem: <input type="number" id="numNumbers" min="2" max="50" value="4" /></label>
                <label>
                    Flash speed (sec):
                    <select id="flashSpeedSec">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </label>
                <label>Flash tokens: <input type="checkbox" id="flashToggle" checked /></label>
                <label>
                    Timer (min):
                    <select id="timerSelect"></select>
                </label>
                <label><input type="checkbox" id="muteSound" /> Mute</label>
                <div class="settings-actions"><button id="cancelSettings">Cancel</button><button id="saveSettings">Save</button></div>
            </div>
        </div>
        <div id="resultsPanel">
            <div class="results-card">
                <h2>Results</h2>
                <div class="results-row" id="resultsList"></div>
                <div id="resultScore"></div>
                <div class="results-footer"><button id="tryAgainBtn">↺ Try Again</button><button id="fullscreenBtnResults">⛶</button></div>
            </div>
        </div>
        <div id="timeUpPanel">
            <div class="timeup-card">
                <h2>Time's Up!</h2>
                <div class="results-footer"><button id="tryAgainTimeUpBtn">↺ Try Again</button><button id="fullscreenBtnTimeUp">⛶</button></div>
            </div>
        </div>
        <audio id="soundOn" src="abacus sound effect 1.wav"></audio>
        <audio id="soundOff" src="abacus sound effect 2.wav"></audio>
        <audio id="tickSound" src="tick.wav"></audio>
        <script>
            // Confetti animation for "Start Quiz!" click

            function launchConfetti() {
                const confetti = document.getElementById("confettiBox");
                confetti.innerHTML = "";
                const colors = ["#ffd700", "#b993d6", "#4d79ff", "#66e6ff", "#ffb3e6", "#ff7878", "#c8ffb0"];
                for (let i = 0; i < 36; i++) {
                    const el = document.createElement("span");
                    el.style.left = Math.random() * 96 + 2 + "%";
                    el.style.background = colors[Math.floor(Math.random() * colors.length)];
                    el.style.animationDuration = 1.1 + Math.random() * 0.5 + "s";
                    el.style.opacity = 0.82 + Math.random() * 0.18;
                    el.style.transform = `rotate(${Math.random() * 360}deg)`;
                    confetti.appendChild(el);
                }
                setTimeout(() => {
                    confetti.innerHTML = "";
                }, 1600);
            }
            // Soroban abacus logic unchanged...
            const $ = (s) => document.querySelector(s),
                $$ = (s) => [...document.querySelectorAll(s)];
            const DEAD_ZONE = 10,
                SHAKE_G = 16,
                HAPTIC_MS = 12;
            let mute = false;
            const board = $("#sorobanBoard");
            function createRod() {
                const r = document.createElement("div");
                r.className = "rod";
                r.innerHTML =
                    "<div class='rod-line'></div><div class='heaven'><div class='bead heaven'></div></div><div class='gap-space'></div><div class='earth'>" + '<div class="bead earth"></div>'.repeat(4) + "</div><div class='bar'></div>";
                return r;
            }
            for (let i = 0; i < 8; i++) board.appendChild(createRod());
            function clearBoard() {
                $$(".bead.active").forEach((b) => b.classList.remove("active"));
            }
            $("#resetBtn").onclick = clearBoard;
            function setBead(b, active) {
                const hv = b.classList.contains("heaven"),
                    was = b.classList.contains("active");
                if (hv) b.classList.toggle("active", active);
                else {
                    const cs = [...b.parentElement.children],
                        idx = cs.indexOf(b);
                    cs.forEach((e, i) => e.classList.toggle("active", active ? i <= idx : i < idx));
                }
                if (HAPTIC_MS) navigator.vibrate(HAPTIC_MS);
                if (!mute) {
                    if (active && !was) $("#soundOn").play();
                    if (!active && was) $("#soundOff").play();
                }
            }
            $$(".bead").forEach((b) =>
                b.addEventListener("pointerdown", (e) => {
                    const rg = b.classList.contains("heaven") ? "heaven" : "earth",
                        sy = e.clientY;
                    b.setPointerCapture(e.pointerId);
                    b.onpointermove = (ev) => {
                        let dy = ev.clientY - sy;
                        if (Math.abs(dy) > DEAD_ZONE) {
                            setBead(b, rg === "heaven" ? dy > 0 : dy < 0);
                            b.onpointermove = null;
                        }
                    };
                    b.onpointerup = b.onpointercancel = () => {
                        b.onpointermove = null;
                        b.releasePointerCapture(e.pointerId);
                    };
                })
            );
            if (window.DeviceMotionEvent) {
                let last = 0;
                window.addEventListener("devicemotion", (e) => {
                    const { x, y, z } = e.accelerationIncludingGravity,
                        mag = Math.hypot(x, y, z),
                        now = performance.now();
                    if (mag > SHAKE_G && now - last > 750) {
                        clearBoard();
                        last = now;
                    }
                });
            }
            // Quiz logic
            function randomChapter1(numQuestions = 10, numNumbers = 4) {
                const out = [];

                while (out.length < numQuestions) {
                    const A = r15(),
                        B = r15(),
                        C = r15(),
                        op1 = rOp();

                    if (A === 5 && op1 === "-" && B !== 5) continue; // 5 − B rule
                    if (A === 5 && op1 === "+" && B === 5) continue; // forbid 5 + 5
                    if (A === 4 && op1 === "-" && !(B >= 1 && B <= 4)) continue;
                    if (A === 4 && op1 === "+" && B !== 5) continue;
                    if (A <= 4 && Math.abs(evalOp(A, op1, B)) > 4) continue;

                    const AB = evalOp(A, op1, B); // first stage

                    /* NEW guard: first-stage must be 0–9 */
                    if (AB < 0 || AB > 9) continue;

                    if (AB === 5) continue; // no stage total may be 5

                    let op2 = AB === 0 ? "+" : rOp(); // 0 → force '+'

                    if (AB === 4 && C !== 5) continue;
                    if (A === 5 && op2 === "+" && !(AB + C >= 5 && AB + C <= 9)) continue;
                    if (A === 5 && op2 === "-" && !(B > C)) continue;

                    const D = evalOp(AB, op2, C); // final result

                    if (D < 0 || D > 9 || D === 5) continue;
                    if (AB < 4 && !(D < 4 || C === 5)) continue;
                    if (A + B === 5 || A + C === 5 || B + C === 5) continue;

                    out.push({ q: `${A} ${op1} ${B} ${op2} ${C}`, a: D.toString() });
                }
                return out;

                function r15() {
                    return Math.floor(Math.random() * 5) + 1;
                }
                function rOp() {
                    return Math.random() < 0.5 ? "+" : "-";
                }
                function evalOp(x, o, y) {
                    return o === "+" ? x + y : x - y;
                }
            }

            /**
             * Generate arithmetic questions for Chapter 2.
             *  - A, B, C ∈ 1‥9
             *  - Two operators (op1, op2) ∈ {+ ,-}
             *  - Result D ∈ 0‥9
             *  - All selection rules in the prompt are enforced.
             */
            function randomChapter2(numQuestions = 10) {
                const out = [];

                while (out.length < numQuestions) {
                    const A = r19();
                    const op1 = rOp();

                    /* -------- FIRST STAGE : choose B that satisfies op1-rules -------- */
                    let B = choose(r19, (b) => (op1 === "+" ? validB_plus(A, b) : validB_minus(A, b)));
                    if (B == null) continue; // give up and retry

                    const stage1 = evalOp(A, op1, B); // S = A ± B
                    if (stage1 < 0 || stage1 > 9) continue; // keep D in 0-9 range later

                    /* -------- SECOND STAGE : choose op2 and C that satisfy combo-rules -------- */
                    const op2 = rOp();
                    let C = choose(r19, (c) => {
                        if (op1 === "+" && op2 === "+") return validC_plusplus(stage1, c);
                        if (op1 === "+" && op2 === "-") return validC_plusminus(stage1, c);
                        if (op1 === "-" && op2 === "+") return validC_minusplus(stage1, c);
                        return validC_minusminus(stage1, c); // - -
                    });
                    if (C == null) continue;

                    const D = evalOp(stage1, op2, C); // final answer
                    if (D < 0 || D > 9) continue;

                    out.push({ q: `${A} ${op1} ${B} ${op2} ${C}`, a: D.toString() });
                }
                return out;

                /* ---------- helpers ---------- */
                function r19() {
                    return Math.floor(Math.random() * 9) + 1;
                }
                function rOp() {
                    return Math.random() < 0.5 ? "+" : "-";
                }
                function evalOp(x, o, y) {
                    return o === "+" ? x + y : x - y;
                }

                /** repeatedly pick a random value until the predicate is true, or give up */
                function choose(generator, ok, tries = 60) {
                    while (tries--) {
                        const v = generator();
                        if (ok(v)) return v;
                    }
                    return null; // give up after N attempts
                }

                /* ---------- rule predicates ---------- */

                /* op1 = '+' ----------------------------------------------------------------*/
                function validB_plus(A, B) {
                    if (A <= 4) return !(B >= 10 - A || (B >= 5 - A && B < 5));
                    if (A === 5) return B < 5;
                    /* A = 6-9 */ return B < 10 - A;
                }

                /* op1 = '-' ----------------------------------------------------------------*/
                function validB_minus(A, B) {
                    if (A <= 4) return B <= A;
                    if (A === 5) return B === 5;
                    /* A = 6-9 */ return B <= A - 5 || B === 5;
                }

                /*  op1 '+'  , op2 '+' ------------------------------------------------------*/
                function validC_plusplus(S, C) {
                    if (S <= 4) return !(C >= 10 - S || (C >= 5 - S && C < 5));
                    if (S === 5) return C < 5;
                    /* S = 6-9 */ return C < 10 - S;
                }

                /*  op1 '+'  , op2 '-' ------------------------------------------------------*/
                function validC_plusminus(S, C) {
                    if (2 <= S && S <= 4) return C < S;
                    if (S === 5) return C === 5;
                    /* S = 6-9 */ return C <= S - 5 || C === 5;
                }

                /*  op1 '-'  , op2 '+' ------------------------------------------------------*/
                function validC_minusplus(S, C) {
                    if (S <= 4) return !(C >= 10 - S || (C >= 5 - S && C < 5));
                    if (S === 5) return C < 5;
                    /* S = 6-9 */ return C < 10 - S;
                }

                /*  op1 '-'  , op2 '-' ------------------------------------------------------*/
                function validC_minusminus(S, C) {
                    if (S <= 4) return C < S; // note: S = 0 gives no valid C
                    if (S === 5) return C === 5;
                    /* S = 6-9 */ return C <= S - 5 || C === 5;
                }
            }

            function randomChapter3(numQuestions = 10) {
                const out = [];
                while (out.length < numQuestions) {
                    const op1 = Math.random() < 0.5 ? "+" : "-";
                    const op2 = Math.random() < 0.5 ? "+" : "-";
                    let A, B, C;

                    if (op1 === "+") {
                        // A ∈ 1–4
                        A = Math.floor(Math.random() * 4) + 1;
                        const pivot = 5 - A;

                        // exactly one of these six sub-cases:
                        switch (Math.floor(Math.random() * 6) + 1) {
                            case 1:
                                B = pivot;
                                C = op2 === "+" ? Math.floor(Math.random() * 4) + 1 : 5;
                                break;
                            case 2:
                                if (pivot <= 1 || op2 !== "+") continue;
                                B = Math.floor(Math.random() * (pivot - 1)) + 1;
                                C = 5 - (A + B);
                                break;
                            case 3:
                                if (pivot >= 5 || op2 !== "+") continue;
                                B = Math.floor(Math.random() * (5 - pivot)) + (pivot + 1);
                                C = Math.floor(Math.random() * (A + B - 1)) + 1;
                                break;
                            case 4:
                                if (op2 !== "-") continue;
                                B = pivot;
                                C = 5;
                                break;
                            case 5:
                                if (pivot <= 1 || op2 !== "-") continue;
                                B = Math.floor(Math.random() * (pivot - 1)) + 1;
                                C = Math.floor(Math.random() * (A + B)) + 1;
                                break;
                            case 6:
                                if (pivot >= 5 || op2 !== "-") continue;
                                B = Math.floor(Math.random() * (5 - pivot)) + (pivot + 1);
                                C = [A + B - 5, 5][Math.random() < 0.5 ? 0 : 1];
                                break;
                        }
                    } else {
                        // op1 = "-"
                        A = Math.floor(Math.random() * 9) + 1;
                        if (A >= 1 && A <= 4) {
                            if (A <= 1 || op2 !== "+") continue;
                            B = Math.floor(Math.random() * (A - 1)) + 1;
                            C = 5 - (A - B);
                        } else if (A >= 6 && A <= 9) {
                            if (op2 !== "+") continue;
                            if (Math.random() < 0.5 && A - 5 >= 1) {
                                B = Math.floor(Math.random() * (A - 5)) + 1;
                                C = Math.floor(Math.random() * 4) + 1;
                            } else {
                                B = 5;
                                C = 5 - (A - B);
                            }
                        } else {
                            continue;
                        }
                    }

                    const stage1 = op1 === "+" ? A + B : A - B;
                    const D = op2 === "+" ? stage1 + C : stage1 - C;
                    if (D < 0 || D > 9) continue;

                    out.push({ q: `${A} ${op1} ${B} ${op2} ${C}`, a: D.toString() });
                }
                return out;
            }

            function randomChapter4(numQuestions = 10) {
                let A, B, C, op2, D, expr;
                const questions = [];
                while (questions.length < numQuestions) {
                    let caseType = Math.random() < 0.5 ? 1 : 2;

                    if (caseType === 1) {
                        A = 5;
                        B = [1, 2, 3, 4][Math.floor(Math.random() * 4)];
                        let AB = A - B;
                        op2 = Math.random() < 0.5 ? "+" : "-";

                        if (op2 === "+") {
                            if (AB === 4) {
                                C = Math.floor(Math.random() * 5) + 1; // 1–5
                            } else if (AB < 4) {
                                let cMin = 5,
                                    cMax = 10 - AB;
                                let cOptions = [];
                                for (let x = cMin; x < cMax; x++) cOptions.push(x);
                                if (cOptions.length === 0) continue;
                                C = cOptions[Math.floor(Math.random() * cOptions.length)];
                            } else {
                                C = Math.floor(Math.random() * 5) + 1;
                            }
                            D = AB + C;
                        } else {
                            if (AB < 1) continue;
                            C = Math.floor(Math.random() * AB) + 1;
                            D = AB - C;
                        }
                        expr = `${A} - ${B} ${op2} ${C}`;
                    } else {
                        A = [6, 7, 8][Math.floor(Math.random() * 3)];
                        let bMin = A - 5 + 1,
                            bMax = 4;
                        let bOptions = [];
                        for (let x = bMin; x < bMax; x++) bOptions.push(x);
                        if (bOptions.length === 0) continue;
                        B = bOptions[Math.floor(Math.random() * bOptions.length)];
                        let AB = A - B;
                        op2 = Math.random() < 0.5 ? "+" : "-";

                        if (op2 === "+") {
                            C = Math.floor(Math.random() * 5) + 1;
                            D = AB + C;
                        } else {
                            if (AB < 1) continue;
                            C = Math.floor(Math.random() * AB) + 1;
                            D = AB - C;
                        }
                        expr = `${A} - ${B} ${op2} ${C}`;
                    }

                    if ([A, B, C].every((v) => v >= 1 && v <= 9) && D >= 0 && D <= 9) {
                        questions.push({ q: expr, a: D.toString() });
                    }
                }
                return questions;
            }

            function alternateQuestions(arr1, arr2, total) {
                const mixed = [];
                let i = 0;
                while (mixed.length < total) {
                    if (i < arr1.length) mixed.push(arr1[i]);
                    if (mixed.length < total && i < arr2.length) mixed.push(arr2[i]);
                    i++;
                }
                return mixed;
            }
            
            function randomChapter6(numQuestions = 10) {
                const questions = [];
                let attempts = 0;

                while (questions.length < numQuestions && attempts < 3000) {
                    attempts++;
                    let A, B, C, op1, op2, expr, D;

                    // Pick a rule at random (0: Rule 1, 1: Rule 2, 2: Rule 3, 3: Rule 4)
                    const ruleType = Math.floor(Math.random() * 4);

                    if (ruleType === 0) {
                        // Rule 1: op1 = '+', A = 1-9, B = 10-A, op2 = '+', C = 1-9
                        op1 = "+";
                        op2 = "+";
                        A = Math.floor(Math.random() * 9) + 1;
                        B = 10 - A;
                        if (B < 1 || B > 9) continue;
                        C = Math.floor(Math.random() * 9) + 1;
                    } else if (ruleType === 1) {
                        // Rule 2: op1 = '+', A = 1-9, B = 1..(9-A), op2 = '+', C = 10-(A+B)
                        op1 = "+";
                        op2 = "+";
                        A = Math.floor(Math.random() * 9) + 1;
                        let maxB = 10 - A - 1; // x < (10-A), x >= 1
                        if (maxB < 1) continue;
                        B = Math.floor(Math.random() * maxB) + 1; // 1..maxB
                        let sumAB = A + B;
                        C = 10 - sumAB;
                        if (C < 1 || C > 9) continue;
                    } else if (ruleType === 2) {
                        // Rule 3: op1 = '+', A = 1-9, B = 1..(9-A), op2 = '-', C <= (A+B)
                        op1 = "+";
                        op2 = "-";
                        A = Math.floor(Math.random() * 9) + 1;
                        let maxB = 10 - A - 1; // x < (10-A)
                        if (maxB < 1) continue;
                        B = Math.floor(Math.random() * maxB) + 1; // 1..maxB
                        let sumAB = A + B;
                        let maxC = Math.min(sumAB, 9);
                        if (maxC < 1) continue;
                        C = Math.floor(Math.random() * maxC) + 1; // 1..maxC
                    } else if (ruleType === 3) {
                        // Rule 4: op1 = '-', A = 1-9, B < A, op2 = '+', C = 10-(A+B)
                        op1 = "-";
                        op2 = "+";
                        A = Math.floor(Math.random() * 9) + 1;
                        if (A === 1) continue; // B must be < A
                        B = Math.floor(Math.random() * (A - 1)) + 1; // 1..A-1
                        let sumAB = A + B;
                        C = 10 - sumAB;
                        if (C < 1 || C > 9) continue;
                    }

                    // Build the expression and compute D left-to-right
                    expr = `${A} ${op1} ${B} ${op2} ${C}`;
                    let result = A;
                    result = op1 === "+" ? result + B : result - B;
                    result = op2 === "+" ? result + C : result - C;

                    // Only accept if all values in range and D in 0..30
                    if ([A, B, C].every((n) => n >= 1 && n <= 9) && result >= 0 && result <= 30) {
                        questions.push({ q: expr, a: result.toString() });
                    }
                }

                // Warning if unable to generate enough questions
                if (questions.length < numQuestions) {
                    alert("Warning: Could not generate enough questions.");
                }

                return questions;
            }

            function randomChapter7(numQuestions = 10) {
    const questions = [];
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 5000) {
        attempts++;
        let A, B, C, D, expr;
        let possibleCs = [];

        // Randomly select which case for A
        let caseType = Math.random();

        // --- CASE 1: A = 1..4, B >= 10-A, op2 = '-'
        if (caseType < 0.38) {
            A = Math.floor(Math.random() * 4) + 1; // 1-4
            let minB = 10 - A;
            if (minB > 9) continue;
            B = Math.floor(Math.random() * (10 - minB)) + minB; // minB..9

            const sum = A + B;

            if (sum <= 10) {
                possibleCs = [1,2,3,4,5,6,7,8,9];
            } else if (sum === 11) {
                possibleCs = [2,3,4,5,7,8,9];
            } else if (sum === 12) {
                possibleCs = [3,4,5,8,9];
            } else if (sum === 13) {
                possibleCs = [4,5,9];
            } else if (sum === 14) {
                possibleCs = [5];
            } else {
                continue;
            }
            if (possibleCs.length === 0) continue;
            C = possibleCs[Math.floor(Math.random() * possibleCs.length)];

        // --- CASE 2: A = 5, B = 5, op2 = '-', C = 1..9
        } else if (caseType < 0.54) {
            A = 5;
            B = 5;
            possibleCs = [1,2,3,4,5,6,7,8,9];
            C = possibleCs[Math.floor(Math.random() * possibleCs.length)];

        // --- CASE 3: A = 6..9, B in [(10-A), 5], op2 = '-'
        } else {
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            let minB = 10 - A;
            let maxB = 5;
            if (minB > 5 || minB > 9) continue;
            // B in [minB, 5] and 1-9
            let possibleBs = [];
            for (let b = minB; b <= maxB; b++) {
                if (b >= 1 && b <= 9) possibleBs.push(b);
            }
            if (possibleBs.length === 0) continue;
            B = possibleBs[Math.floor(Math.random() * possibleBs.length)];

            const sum = A + B;

            if (sum === 10) {
                possibleCs = [1,2,3,4,5,6,7,8,9];
            } else if (sum === 11) {
                possibleCs = [2,3,4,5,7,8,9];
            } else if (sum === 12) {
                possibleCs = [3,4,5,8,9];
            } else if (sum === 13) {
                possibleCs = [4,5,9];
            } else if (sum === 14) {
                possibleCs = [5];
            } else {
                continue;
            }
            if (possibleCs.length === 0) continue;
            C = possibleCs[Math.floor(Math.random() * possibleCs.length)];
        }

        expr = `${A} + ${B} - ${C}`;
        D = A + B - C;

        if (
            [A, B, C].every(n => n >= 1 && n <= 9) &&
            D >= 0 && D <= 100
        ) {
            questions.push({ q: expr, a: D.toString() });
        }
    }

    if (questions.length < numQuestions) {
        alert('Warning: Could not generate enough questions.');
    }

    return questions;
}
  
function alternateQuestions1(arr1, arr2, total) {
                const mixed = [];
                let i = 0;
                while (mixed.length < total) {
                    if (i < arr1.length) mixed.push(arr1[i]);
                    if (mixed.length < total && i < arr2.length) mixed.push(arr2[i]);
                    i++;
                }
                return mixed;
            }



function randomChapter9(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 2000) {
        attempts++;
        let A, B, C, D, op1, op2, expr;

        // Randomly select which rule to use
        let ruleType = Math.floor(Math.random() * 4);

        if (ruleType === 0) {
            // Rule 1: op1 = '+', A = 5, B = 9, op2 = '+', C = 1-9
            op1 = '+';
            op2 = '+';
            A = 5;
            B = 9;
            C = Math.floor(Math.random() * 9) + 1; // 1-9
        } else if (ruleType === 1) {
            // Rule 2: op1 = '+', A = 1-4, B = 5-A, op2 = '+', C = 9
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1; // 1-4
            B = 5 - A;
            C = 9;
        } else if (ruleType === 2) {
            // Rule 3: op1 = '+', A = 6-9, B = 15-A, op2 = '+', C = 9
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 15 - A;
            C = 9;
        } else if (ruleType === 3) {
            // Rule 4: op1 = '-', A = 6-9, B = A-5, op2 = '+', C = 9
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = A - 5;
            C = 9;
        }

        expr = `${A} ${op1} ${B} ${op2} ${C}`;
        // Compute D left-to-right
        let result = A;
        result = op1 === '+' ? result + B : result - B;
        result = op2 === '+' ? result + C : result - C;

        if (
            [A, B, C].every(n => n >= 1 && n <= 9) &&
            result >= 0 && result <= 100 &&
            !seen.has(expr)
        ) {
            questions.push({ q: expr, a: result.toString() });
            seen.add(expr);
        }
    }
    return questions;
}



function randomChapter10(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 4000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // Pick one of the 7 rules randomly
        let ruleType = Math.floor(Math.random() * 7);

        if (ruleType === 0) {
            // Rule 1: op1 = '+', A = 5 or 6, B = 8, op2 = '+', C = 1-9
            op1 = '+';
            op2 = '+';
            A = Math.random() < 0.5 ? 5 : 6;
            B = 8;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // Rule 2: op1 = '+', A = 1-4, B = 5-A, op2 = '+', C = 8
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 5 - A;
            C = 8;
        } else if (ruleType === 2) {
            // Rule 3: op1 = '+', A = 1-4, B = 6-A, op2 = '+', C = 8
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 6 - A;
            C = 8;
        } else if (ruleType === 3) {
            // Rule 4: op1 = '+', A = 6-9, B = 15-A, op2 = '+', C = 8
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 15 - A;
            C = 8;
        } else if (ruleType === 4) {
            // Rule 5: op1 = '+', A = 6-9, B = 16-A, op2 = '+', C = 8
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 16 - A;
            C = 8;
        } else if (ruleType === 5) {
            // Rule 6: op1 = '-', A = 6-9, B = A-5, op2 = '+', C = 8
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 5;
            C = 8;
        } else if (ruleType === 6) {
            // Rule 7: op1 = '-', A = 6-9, B = A-6, op2 = '+', C = 8
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 6;
            C = 8;
        }

        // Make sure all values are in 1-9
        if ([A, B, C].every(n => n >= 1 && n <= 9)) {
            expr = `${A} ${op1} ${B} ${op2} ${C}`;
            result = A;
            result = op1 === '+' ? result + B : result - B;
            result = op2 === '+' ? result + C : result - C;

            if (result >= 0 && result <= 100 && !seen.has(expr)) {
                questions.push({ q: expr, a: result.toString() });
                seen.add(expr);
            }
        }
    }

        return questions;
}



function randomChapter11(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 6000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // Randomly pick a rule (there are 10)
        let ruleType = Math.floor(Math.random() * 10);

        if (ruleType === 0) {
            // 1: op1 = '+', A=5/6/7, B=7, op2='+', C=1-9
            op1 = '+';
            op2 = '+';
            A = [5,6,7][Math.floor(Math.random()*3)];
            B = 7;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // 2: op1='+', A=1-4, B=5-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 5 - A;
            C = 7;
        } else if (ruleType === 2) {
            // 3: op1='+', A=1-4, B=6-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 6 - A;
            C = 7;
        } else if (ruleType === 3) {
            // 4: op1='+', A=1-4, B=7-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 7 - A;
            C = 7;
        } else if (ruleType === 4) {
            // 5: op1='+', A=6-9, B=15-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 15 - A;
            C = 7;
        } else if (ruleType === 5) {
            // 6: op1='+', A=6-9, B=16-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 16 - A;
            C = 7;
        } else if (ruleType === 6) {
            // 7: op1='+', A=6-9, B=17-A, op2='+', C=7
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 17 - A;
            C = 7;
        } else if (ruleType === 7) {
            // 8: op1='-', A=6-9, B=A-5, op2='+', C=7
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 5;
            C = 7;
        } else if (ruleType === 8) {
            // 9: op1='-', A=6-9, B=A-6, op2='+', C=7
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 6;
            C = 7;
        } else if (ruleType === 9) {
            // 10: op1='-', A=7-9, B=A-7, op2='+', C=7
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 3) + 7;
            B = A - 7;
            C = 7;
        }

        // Check all are 1-9
        if ([A, B, C].every(n => n >= 1 && n <= 9)) {
            expr = `${A} ${op1} ${B} ${op2} ${C}`;
            result = op1 === '+' ? (A + B) : (A - B);
            result = op2 === '+' ? (result + C) : (result - C);

            if (result >= 0 && result <= 100 && !seen.has(expr)) {
                questions.push({ q: expr, a: result.toString() });
                seen.add(expr);
            }
        }
    }

    return questions;
}



function randomChapter12(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 8000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // 14 total rules
        let ruleType = Math.floor(Math.random() * 14);

        if (ruleType === 0) {
            // 1: op1 = '+', A=5/6/7/8, B=6, op2='+', C=1-9
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 5; // 5-8
            B = 6;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // 2: op1='+', A=1-4, B=5-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 5 - A;
            C = 6;
        } else if (ruleType === 2) {
            // 3: op1='+', A=1-4, B=6-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 6 - A;
            C = 6;
        } else if (ruleType === 3) {
            // 4: op1='+', A=1-4, B=7-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 7 - A;
            C = 6;
        } else if (ruleType === 4) {
            // 5: op1='+', A=1-4, B=8-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 1;
            B = 8 - A;
            C = 6;
        } else if (ruleType === 5) {
            // 6: op1='+', A=6-9, B=15-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 15 - A;
            C = 6;
        } else if (ruleType === 6) {
            // 7: op1='+', A=6-9, B=16-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 16 - A;
            C = 6;
        } else if (ruleType === 7) {
            // 8: op1='+', A=6-9, B=17-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 17 - A;
            C = 6;
        } else if (ruleType === 8) {
            // 9: op1='+', A=6-9, B=18-A, op2='+', C=6
            op1 = '+';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = 18 - A;
            C = 6;
        } else if (ruleType === 9) {
            // 10: op1='-', A=6-9, B=A-5, op2='+', C=6
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 5;
            C = 6;
        } else if (ruleType === 10) {
            // 11: op1='-', A=6-9, B=A-6, op2='+', C=6
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 6;
            B = A - 6;
            C = 6;
        } else if (ruleType === 11) {
            // 12: op1='-', A=7-9, B=A-7, op2='+', C=6
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 3) + 7;
            B = A - 7;
            C = 6;
        } else if (ruleType === 12) {
            // 13: op1='-', A=8-9, B=A-8, op2='+', C=6
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 2) + 8;
            B = A - 8;
            C = 6;
        }

        // Only allow A, B, C in 1-9
        if ([A, B, C].every(n => n >= 1 && n <= 9)) {
            expr = `${A} ${op1} ${B} ${op2} ${C}`;
            result = op1 === '+' ? (A + B) : (A - B);
            result = op2 === '+' ? (result + C) : (result - C);

            if (result >= 0 && result <= 100 && !seen.has(expr)) {
                questions.push({ q: expr, a: result.toString() });
                seen.add(expr);
            }
        }
    }
    return questions;
}

function randomChapter13(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 2000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // Randomly choose one of the three rules
        const ruleType = Math.floor(Math.random() * 3);

        if (ruleType === 0) {
            // Rule 1: '-'  A=14, B=9, op2='+', C=1-9
            op1 = '-';
            op2 = '+';
            A = 14;
            B = 9;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // Rule 2: '-'  A=14, B=9, op2='-', C=1-5
            op1 = '-';
            op2 = '-';
            A = 14;
            B = 9;
            C = Math.floor(Math.random() * 5) + 1;
        } else if (ruleType === 2) {
            // Rule 3: '+'  A=6-9, B=14-A, op2='-', C=9
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 14 - A;
            C = 9;
            // Make sure B is in 1-9 range
            if (B < 1 || B > 9) continue;
        }

        expr = `${A} ${op1} ${B} ${op2} ${C}`;
        result = op1 === '+' ? (A + B) : (A - B);
        result = op2 === '+' ? (result + C) : (result - C);

        // Make sure everything is within bounds and not duplicate
        if ([A, B, C].every(x => x >= 1 && x <= 14) &&
            result >= 0 && result <= 100 &&
            !seen.has(expr)
        ) {
            questions.push({ q: expr, a: result.toString() });
            seen.add(expr);
        }
    }

    return questions;
}


function randomChapter14(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 2000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // Randomly choose one of the four rules
        const ruleType = Math.floor(Math.random() * 4);

        if (ruleType === 0) {
            // Rule 1: '-'  A=13 or 14, B=8, op2='+', C=1-9
            op1 = '-';
            op2 = '+';
            A = Math.random() < 0.5 ? 13 : 14;
            B = 8;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // Rule 2: '-'  A=13 or 14, B=8, op2='-', C=1-5
            op1 = '-';
            op2 = '-';
            A = Math.random() < 0.5 ? 13 : 14;
            B = 8;
            C = Math.floor(Math.random() * 5) + 1;
        } else if (ruleType === 2) {
            // Rule 3: '+'  A=6-9, B=14-A, op2='-', C=8
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 14 - A;
            C = 8;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 3) {
            // Rule 4: '+'  A=6-9, B=13-A, op2='-', C=8
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 13 - A;
            C = 8;
            if (B < 1 || B > 9) continue;
        }

        expr = `${A} ${op1} ${B} ${op2} ${C}`;
        result = op1 === '+' ? (A + B) : (A - B);
        result = op2 === '+' ? (result + C) : (result - C);

        // Check values and uniqueness
        if (
            [A, B, C].every(x => x >= 1 && x <= 14) &&
            result >= 0 && result <= 100 &&
            !seen.has(expr)
        ) {
            questions.push({ q: expr, a: result.toString() });
            seen.add(expr);
        }
    }

    return questions;
}


function randomChapter15(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 2000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // Randomly pick a rule (there are 6 rules)
        let ruleType = Math.floor(Math.random() * 6);

        if (ruleType === 0) {
            // Rule 1: '-' A=12,13,14 B=7 op2='+' C=1-9
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 3) + 12; // 12-14
            B = 7;
            C = Math.floor(Math.random() * 9) + 1;
        } else if (ruleType === 1) {
            // Rule 2: '-' A=12,13,14 B=7 op2='-' C=1-5
            op1 = '-';
            op2 = '-';
            A = Math.floor(Math.random() * 3) + 12; // 12-14
            B = 7;
            C = Math.floor(Math.random() * 5) + 1;
        } else if (ruleType === 2) {
            // Rule 3: '+' A=6-9 B=14-A op2='-' C=7
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 14 - A;
            C = 7;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 3) {
            // Rule 4: '+' A=6-9 B=13-A op2='-' C=7
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 13 - A;
            C = 7;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 4) {
            // Rule 5: '+' A=6-9 B=12-A op2='-' C=7
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 12 - A;
            C = 7;
            if (B < 1 || B > 9) continue;
        }

        expr = `${A} ${op1} ${B} ${op2} ${C}`;
        result = op1 === '+' ? (A + B) : (A - B);
        result = op2 === '+' ? (result + C) : (result - C);

        // All values in allowed range, uniqueness check
        if (
            [A, B, C].every(x => x >= 1 && x <= 14) &&
            result >= 0 && result <= 100 &&
            !seen.has(expr)
        ) {
            questions.push({ q: expr, a: result.toString() });
            seen.add(expr);
        }
    }

    return questions;
}

function randomChapter16(numQuestions = 10) {
    const questions = [];
    const seen = new Set();
    let attempts = 0;

    while (questions.length < numQuestions && attempts < 3000) {
        attempts++;
        let A, B, C, op1, op2, expr, result;

        // There are 6 rules
        let ruleType = Math.floor(Math.random() * 6);

        if (ruleType === 0) {
            // Rule 1: '-' A=11,12,13,14 B=6 op2='+' C=1-9
            op1 = '-';
            op2 = '+';
            A = Math.floor(Math.random() * 4) + 11; // 11-14
            B = 6;
            C = Math.floor(Math.random() * 9) + 1; // 1-9
        } else if (ruleType === 1) {
            // Rule 2: '-' A=11,12,13,14 B=6 op2='-' C=1-5
            op1 = '-';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 11; // 11-14
            B = 6;
            C = Math.floor(Math.random() * 5) + 1; // 1-5
        } else if (ruleType === 2) {
            // Rule 3: '+' A=6-9 B=14-A op2='-' C=6
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 14 - A;
            C = 6;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 3) {
            // Rule 4: '+' A=6-9 B=13-A op2='-' C=6
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 13 - A;
            C = 6;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 4) {
            // Rule 5: '+' A=6-9 B=12-A op2='-' C=6
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 12 - A;
            C = 6;
            if (B < 1 || B > 9) continue;
        } else if (ruleType === 5) {
            // Rule 6: '+' A=6-9 B=11-A op2='-' C=6
            op1 = '+';
            op2 = '-';
            A = Math.floor(Math.random() * 4) + 6; // 6-9
            B = 11 - A;
            C = 6;
            if (B < 1 || B > 9) continue;
        }

        expr = `${A} ${op1} ${B} ${op2} ${C}`;
        result = op1 === '+' ? (A + B) : (A - B);
        result = op2 === '+' ? (result + C) : (result - C);

        // All values in allowed range, uniqueness check
        if (
            [A, B, C].every(x => x >= 1 && x <= 14) &&
            result >= 0 && result <= 100 &&
            !seen.has(expr)
        ) {
            questions.push({ q: expr, a: result.toString() });
            seen.add(expr);
        }
    }

    return questions;
}

function randomChapter17(numQuestions = 10) {
    const questions = [];
    let attempts = 0;
    const ops = ["+", "-"];

    while (questions.length < numQuestions && attempts < 3000) {
        attempts++;
        const A = Math.floor(Math.random() * 9) + 1;
        const B = Math.floor(Math.random() * 9) + 1;
        const C = Math.floor(Math.random() * 9) + 1;
        const op1 = ops[Math.floor(Math.random() * 2)];
        const op2 = ops[Math.floor(Math.random() * 2)];

        // If op1 is '-', ensure A >= B (A-B not negative)
        if (op1 === "-" && A < B) continue;

        // Calculate intermediate step
        let step1 = op1 === "+" ? A + B : A - B;

        // If op2 is '-' ensure step1 >= C ((A+-B)-C not negative)
        if (op2 === "-" && step1 < C) continue;

        // Calculate final result
        let D = op2 === "+" ? step1 + C : step1 - C;

        // D must be in 0-9
        if (D >= 0 && D <= 9) {
            questions.push({
                q: `${A} ${op1} ${B} ${op2} ${C}`,
                a: D.toString()
            });
        }
    }

    return questions;
}

function randomChapter18(numQuestions = 10) {
    const questions = [];
    let attempts = 0;
    const ops = ["+", "-"];

    while (questions.length < numQuestions && attempts < 10000) {
        attempts++;
        const A = Math.floor(Math.random() * 59) + 1;
        const B = Math.floor(Math.random() * 59) + 1;
        const C = Math.floor(Math.random() * 59) + 1;
        const op1 = ops[Math.floor(Math.random() * 2)];
        const op2 = ops[Math.floor(Math.random() * 2)];

        // If op1 is '-', ensure A >= B (A-B not negative)
        if (op1 === "-" && A < B) continue;

        // Calculate intermediate step
        let step1 = op1 === "+" ? A + B : A - B;

        // If op2 is '-', ensure step1 >= C
        if (op2 === "-" && step1 < C) continue;

        // Calculate final result
        let D = op2 === "+" ? step1 + C : step1 - C;

        // D must be in 10–99
        if (D >= 10 && D <= 99) {
            questions.push({
                q: `${A} ${op1} ${B} ${op2} ${C}`,
                a: D.toString()
            });
        }
    }

    return questions;
}

function randomChapter19(numQuestions = 10) {
    const questions = [];
    let attempts = 0;
    const ops = ["+", "-"];

    while (questions.length < numQuestions && attempts < 30000) {
        attempts++;
        const A = Math.floor(Math.random() * 99) + 1;
        const B = Math.floor(Math.random() * 99) + 1;
        const C = Math.floor(Math.random() * 99) + 1;
        const op1 = ops[Math.floor(Math.random() * 2)];
        const op2 = ops[Math.floor(Math.random() * 2)];

        // Ensure no negatives after first op
        if (op1 === "-" && A < B) continue;

        let step1 = op1 === "+" ? A + B : A - B;

        // Ensure no negatives after second op
        if (op2 === "-" && step1 < C) continue;

        let D = op2 === "+" ? step1 + C : step1 - C;

        // D must be 100–999
        if (D >= 100 && D <= 999) {
            questions.push({
                q: `${A} ${op1} ${B} ${op2} ${C}`,
                a: D.toString()
            });
        }
    }

    return questions;
}


function randomChapter20(numQuestions = 10) {
    const questions = [];
    let attempts = 0;
    const ops = ["+", "-"];

    while (questions.length < numQuestions && attempts < 40000) {
        attempts++;

        const A = Math.floor(Math.random() * 999) + 1;
        const B = Math.floor(Math.random() * 999) + 1;
        const C = Math.floor(Math.random() * 999) + 1;
        const op1 = ops[Math.floor(Math.random() * 2)];
        const op2 = ops[Math.floor(Math.random() * 2)];

        // A-B must not be negative
        if (op1 === "-" && A < B) continue;

        let step1 = op1 === "+" ? A + B : A - B;

        // (A+-B)-C must not be negative
        if (op2 === "-" && step1 < C) continue;

        let D = op2 === "+" ? step1 + C : step1 - C;

        // D must be 1000–9999
        if (D >= 1000 && D <= 9999) {
            questions.push({
                q: `${A} ${op1} ${B} ${op2} ${C}`,
                a: D.toString()
            });
        }
    }

    return questions;
}


            // Settings & state

            let numQuestions = 10,
                numNumbers = 4,
                flashSpeed = 1,
                flashEnabled = true,
                timerMinutes = 10;
            let QUESTIONS = [],
                currentIndex = 0,
                answers = [],
                currentInput = "",
                inputLocked = false,
                timerInterval,
                timeLeft = 600;
            let flashTokenTimer = null;
            const qNumEl = $("#qNum"),
                qTextEl = $("#qText"),
                answerEl = $("#answerDisplay"),
                sendBtnEl = $("#sendBtn");
            const timerEl = $("#quizTimer"),
                padContainer = $("#numpad");
            const settingsBtn = $("#settingsBtn"),
                settingsPanel = $("#settingsPanel");
            const flashSpeedSec = $("#flashSpeedSec"),
                flashToggle = $("#flashToggle");
            const numQuestionsInput = $("#numQuestions"),
                numNumbersInput = $("#numNumbers");
            const timerSelect = $("#timerSelect"),
                muteSoundInput = $("#muteSound");
            for (let i = 1; i <= 10; i++) {
                let opt = document.createElement("option");
                opt.value = i;
                opt.textContent = i;
                if (i === 10) opt.selected = true;
                timerSelect.appendChild(opt);
            }
            padContainer.innerHTML = "";
            ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "C", "BACK"].forEach((d) => {
                const b = document.createElement("button");
                b.innerHTML = d === "BACK" ? "⌫" : d;
                b.onclick = () => appendDigit(d);
                padContainer.appendChild(b);
            });
            // Start Panel logic
            function showStartPanel() {
                $("#startPanel").style.display = "flex";
                $("#quizPanel").style.display = "none";
                $("#resultsPanel").style.display = "none";
                $("#timeUpPanel").style.display = "none";
            }
            function hideStartPanel() {
                $("#startPanel").style.display = "none";
            }
            $("#startQuizBtn").onclick = () => {
                hideStartPanel();
                setTimeout(() => launchConfetti(), 100);
                startQuiz();
            };
            $("#startSettingsBtn").onclick = () => {
                settingsPanel.style.display = "flex";
            };
            // Settings panel setup
            settingsBtn.onclick = () => {
                settingsPanel.style.display = "flex";
                numQuestionsInput.value = numQuestions;
                numNumbersInput.value = numNumbers;
                flashSpeedSec.value = flashSpeed;
                flashToggle.checked = flashEnabled;
                timerSelect.value = timerMinutes;
                muteSoundInput.checked = mute;
            };
            $("#cancelSettings").onclick = () => (settingsPanel.style.display = "none");
            $("#saveSettings").onclick = () => {
                numQuestions = Math.max(1, Math.min(50, Number(numQuestionsInput.value)));
                numNumbers = Math.max(2, Math.min(50, Number(numNumbersInput.value)));
                flashSpeed = Math.max(1, Math.min(5, Number(flashSpeedSec.value)));
                flashEnabled = !!flashToggle.checked;
                timerMinutes = Math.max(1, Math.min(10, Number(timerSelect.value)));
                mute = muteSoundInput.checked;
                settingsPanel.style.display = "none";
            };
            // ---- Tokenize logic for flash
            function parseQuestionToTokens(q) {
                let arr = q
                    .split(/([+-])/)
                    .map((s) => s.trim())
                    .filter(Boolean);
                let tokens = [];
                tokens.push({ type: "first", val: arr[0] });
                for (let i = 1; i < arr.length; i += 2) {
                    tokens.push({ type: "op", op: arr[i], val: arr[i + 1] });
                }
                return tokens;
            }
            function flashQuestionTokens(questionString, cb) {
                if (flashTokenTimer) clearTimeout(flashTokenTimer);
                let tokens = parseQuestionToTokens(questionString);
                let idx = 0;
                qTextEl.innerHTML = "";
                let centerDiv = document.createElement("div");
                centerDiv.className = "flash-center";
                qTextEl.appendChild(centerDiv);
                inputLocked = true;
                sendBtnEl.disabled = true;
                function showNext() {
                    centerDiv.innerHTML = "";
                    if (idx < tokens.length) {
                        let html = "";
                        if (tokens[idx].type === "first") {
                            html = tokens[idx].val;
                        } else {
                            // Check previous op/num for consecutive duplicates
                            let highlight = false;
                            if (idx > 1) {
                                let prev = tokens[idx - 1];
                                if (prev.type === "op" && prev.op === tokens[idx].op && prev.val === tokens[idx].val) {
                                    highlight = true;
                                }
                            }
                            let opClass = highlight ? "diff-op" : "";
                            let numClass = highlight ? "diff-num" : "";
                            html = `<span class="${opClass}">${tokens[idx].op}</span> <span class="${numClass}">${tokens[idx].val}</span>`;
                            if (idx === tokens.length - 1) {
                                html += `<span class="qmark">?</span>`;
                            }
                        }
                        centerDiv.innerHTML = html;
                        if (!mute) {
                            $("#tickSound").currentTime = 0;
                            $("#tickSound").play();
                        }
                        if (idx === tokens.length - 1) {
                            flashTokenTimer = setTimeout(() => {
                                // Show the full question at the end
                                qTextEl.innerHTML = `<span class="full-question-text">${questionString.replace(/\s*$/, "")} <span class="qmark">?</span></span>`;
                                inputLocked = false;
                                sendBtnEl.disabled = currentInput === "";
                                cb && cb();
                            }, flashSpeed * 1000);
                            sendBtnEl.disabled = false;
                        } else {
                            flashTokenTimer = setTimeout(() => {
                                idx++;
                                showNext();
                            }, flashSpeed * 1000);
                        }
                    }
                }
                showNext();
            }
            // ---- Quiz logic ----
            function appendDigit(d) {
                if (inputLocked) return;
                if (d === "C") currentInput = "";
                else if (d === "BACK") currentInput = currentInput.slice(0, -1);
                else currentInput += d;
                answerEl.textContent = currentInput || "0";
                sendBtnEl.disabled = currentInput.length === 0;
            }
            function loadQuestion() {
                const q = QUESTIONS[currentIndex];
                qNumEl.textContent = "Q" + (currentIndex + 1);
                answerEl.textContent = "0";
                currentInput = "";
                inputLocked = true;
                sendBtnEl.disabled = true;
                if (flashEnabled) {
                    flashQuestionTokens(q.q, () => {
                        inputLocked = false;
                        sendBtnEl.disabled = currentInput === "";
                    });
                } else {
                    qTextEl.innerHTML = `<span class="full-question-text">${q.q} <span class="qmark">?</span></span>`;
                    inputLocked = false;
                    sendBtnEl.disabled = currentInput === "";
                }
            }
            function updateTimer() {
                let m = String(Math.floor(timeLeft / 60)).padStart(2, "0"),
                    s = String(timeLeft % 60).padStart(2, "0");
                timerEl.textContent = "Time Left: " + m + ":" + s;
            }
            function submitAnswer() {
                if (inputLocked || currentInput.length === 0) return;
                inputLocked = true;
                answers.push({ question: QUESTIONS[currentIndex].q, correct: QUESTIONS[currentIndex].a, user: currentInput });
                sendBtnEl.disabled = true;
                if (currentIndex < QUESTIONS.length - 1) {
                    setTimeout(() => {
                        currentIndex++;
                        loadQuestion();
                    }, 350);
                } else {
                    showResults();
                }
            }

            function startQuiz() {
                // ---- 1) reset state ----
                if (flashTokenTimer) clearTimeout(flashTokenTimer);
                currentIndex = 0;
                answers = [];
                currentInput = "";
                inputLocked = true;
                timeLeft = timerMinutes * 60;

                $("#quizPanel").style.display = "flex";
                $("#resultsPanel").style.display = "none";
                $("#timeUpPanel").style.display = "none";

                // ---- choose which generator to use ----
                const url = new URL(location.href);
                const chapter = parseInt(url.searchParams.get("chapter") || "1", 10);

                    if (chapter >= 20) {
                    QUESTIONS = randomChapter20(numQuestions);
                    console.log("Generator used → randomChapter20");

                 } else if (chapter >= 19) {
                    QUESTIONS = randomChapter19(numQuestions);
                    console.log("Generator used → randomChapter19");

                 } else if (chapter >= 18) {
                    QUESTIONS = randomChapter18(numQuestions);
                    console.log("Generator used → randomChapter18");

                 } else if (chapter >= 17) {
                    QUESTIONS = randomChapter17(numQuestions);
                    console.log("Generator used → randomChapter17");

                 } else if (chapter >= 16) {
                    QUESTIONS = randomChapter16(numQuestions);
                    console.log("Generator used → randomChapter16");

                } else if (chapter >= 15) {
                    QUESTIONS = randomChapter15(numQuestions);
                    console.log("Generator used → randomChapter15");

                } else if (chapter >= 14) {
                    QUESTIONS = randomChapter14(numQuestions);
                    console.log("Generator used → randomChapter14");

                } else if (chapter >= 13) {
                    QUESTIONS = randomChapter13(numQuestions);
                    console.log("Generator used → randomChapter13");

                } else if (chapter >= 12) {
                    QUESTIONS = randomChapter12(numQuestions);
                    console.log("Generator used → randomChapter12");

                } else if (chapter >= 11) {
                    QUESTIONS = randomChapter11(numQuestions);
                    console.log("Generator used → randomChapter11");

                } else if (chapter >= 10) {
                    QUESTIONS = randomChapter10(numQuestions);
                    console.log("Generator used → randomChapter10");

                } else if (chapter >= 9) {
                    QUESTIONS = randomChapter9(numQuestions);
                    console.log("Generator used → randomChapter9");

                } else if (chapter === 8) {
                    // For chapter 8, alternate questions from randomChapter6 and randomChapter7
                    const half = Math.ceil(numQuestions / 2);
                    const ch6 = randomChapter6(half);
                    const ch7 = randomChapter7(numQuestions - half);
                    QUESTIONS = alternateQuestions1(ch6, ch7, numQuestions);
                    console.log("Generator used → MIXED randomChapter6 + randomChapter7");

                } else if (chapter >= 7) {
                    QUESTIONS = randomChapter7(numQuestions);
                    console.log("Generator used → randomChapter7");

                } else if (chapter >= 6) {
                    QUESTIONS = randomChapter6(numQuestions);
                    console.log("Generator used → randomChapter6");

                } else if (chapter === 5) {
                    // For chapter 5, alternate questions from randomChapter3 and randomChapter4
                    const half = Math.ceil(numQuestions / 2);
                    const ch3 = randomChapter3(half);
                    const ch4 = randomChapter4(numQuestions - half);
                    QUESTIONS = alternateQuestions(ch3, ch4, numQuestions);
                    console.log("Generator used → MIXED randomChapter3 + randomChapter4");

                } else if (chapter >= 4) {
                    QUESTIONS = randomChapter4(numQuestions);
                    console.log("Generator used → randomChapter4");

                } else if (chapter >= 3) {
                    QUESTIONS = randomChapter3(numQuestions);
                    console.log("Generator used → randomChapter3");

                } else if (chapter >= 2) {
                    QUESTIONS = randomChapter2(numQuestions);
                    console.log("Generator used → randomChapter2");

                } else {
                    QUESTIONS = randomChapter1(numQuestions, numNumbers);
                    console.log("Generator used → randomChapter1");
                }

                // ---- kick off first question & timer ----
                loadQuestion();
                updateTimer();

                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimer();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        showTimeUp();
                    }
                }, 1000);
            }

            sendBtnEl.onclick = submitAnswer;
            answerEl.onclick = submitAnswer;
            // --- Results panel
            function showResults() {
                $("#quizPanel").style.display = "none";
                $("#resultsPanel").style.display = "flex";
                $("#timeUpPanel").style.display = "none";
                clearInterval(timerInterval);
                const rl = $("#resultsList"),
                    rs = $("#resultScore");
                rl.innerHTML = "";
                let sc = 0;
                answers.forEach((a, i) => {
                    let cor = a.user === a.correct;
                    if (cor) sc++;
                    let di = document.createElement("div");
                    di.className = "result-item";
                    di.innerHTML = `<div class='question-text'>Q${i + 1}: ${a.question}</div><div class='your-answer'><span class='mark'>${cor ? "✔️" : "❌"}</span><span>Your: ${a.user}</span></div>${
                        !cor ? `<div class='correct-answer'>Correct: ${a.correct}</div>` : ""
                    }`;
                    rl.appendChild(di);
                });
                rs.textContent = `You scored ${sc}/${answers.length}`;
            }
            $("#tryAgainBtn").onclick = startQuiz;
            $("#fullscreenBtnResults").onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };
            // --- Time Up panel
            function showTimeUp() {
                $("#quizPanel").style.display = "none";
                $("#resultsPanel").style.display = "none";
                $("#timeUpPanel").style.display = "flex";
            }
            $("#tryAgainTimeUpBtn").onclick = startQuiz;
            $("#fullscreenBtnTimeUp").onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };
            // --- Fullscreen button
            $("#fullscreenBtn").onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };
            // --- Mute
            muteSoundInput.onchange = () => {
                mute = muteSoundInput.checked;
            };
            // --- Init: show start panel
            showStartPanel();
        </script>
    </body>
</html>
