<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Soroban Canvas Quiz</title>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:#b3c4e7; font-family:sans-serif; }
    #abacusRoot { position:absolute; top:0; right:0; width:100vw; height:100vh; display:flex; justify-content:flex-end; align-items:center; background:#4d79ff; overflow:hidden; z-index:1; }
    .soroban { display:flex; justify-content:center; align-items:center; padding:5px; width:160%; height:100%; }
    .rod { position:relative; width:95px; height:390px; background:#4d79ff; border-radius:5px; display:flex; flex-direction:column; align-items:center; justify-content:space-between; }
    .rod-line { position:absolute; top:0; bottom:0; width:3px; background:#6666ff; z-index:0; }
    .heaven, .earth, .gap-space, .bar { z-index:1; }
    .heaven { display:flex; flex-direction:column; justify-content:flex-end; align-items:center; height:14%; gap:2px; }
    .gap-space { height:2%; }
    .earth { display:flex; flex-direction:column; justify-content:flex-start; align-items:center; height:53%; margin-top:3px; gap:3px; }
    .bar { position:absolute; top:27%; width:100%; height:3px; background:#6666ff; }
    .bead { width:90px; height:50px; background:linear-gradient(to bottom, #002db3, #002080); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); box-shadow:inset -1px -1px 4px rgba(255,255,255,0.3),inset 1px 1px 4px rgba(0,0,0,0.3); transition:transform 0.2s; touch-action:none; z-index:3; }
    .bead.active { background:radial-gradient(circle at 30% 30%, #ffd700, #ffa500); box-shadow:inset -2px -2px 5px rgba(255,255,255,0.4),inset 2px 2px 5px rgba(0,0,0,0.3); }
    .bead.heaven.active { transform:translateY(100%); }
    .bead.earth.active { transform:translateY(-150%); }
    #quizPanel { position:absolute; top:0; left:0; width:clamp(260px,22vw,380px); height:100vh; background:rgba(140,166,219,0.95); color:#fff; z-index:2; display:flex; flex-direction:column; padding:1rem; }
    #topBtns { display:flex; justify-content:flex-end; align-items:center; margin-bottom:0.5rem; gap:0.5rem; }
    #topBtns button { background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer; }
    #quizContent { flex:1; display:flex; flex-direction:column; gap:1rem; overflow-y:auto; }
    .question { display:flex; align-items:center; gap:0.5rem; }
    #qNum { background:#668cff; padding:0.3rem 0.8rem; border-radius:0.3rem; font-weight:bold; }
    #qText { flex:1; display:flex; justify-content:center; align-items:center; min-height:3.4rem; font-size:2.6rem; font-weight:bold; text-align:center; letter-spacing:1px; transition:.2s; position:relative; }
    .flash-center { display:flex; align-items:center; justify-content:center; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:100%; text-align:center; z-index:2; font-size:2.8rem; font-weight:bold; color:#fff; letter-spacing:0.08em; min-width:1em; }
    .flash-center .qmark { color:#e53; font-size:1em; font-weight:bold; margin-left:0.18em; vertical-align:middle; }
    .flash-center .diff-num { color:#ffd700; }
    .flash-center .diff-op { color:#ff5757; }
    .full-question-text { font-size:2rem; color:#fff; font-weight:bold; letter-spacing:0.06em; text-align:center; width:100%; opacity:1; }
    .input-label { font-weight:bold; }
    .inputArea { display:flex; gap:0.5rem; align-items:center; }
    #answerDisplay { flex:1; background:#fff; color:#333; text-align:right; padding:0.5rem; border:2px solid #b993d6; border-radius:0.4rem; font-size:1.2rem; user-select:none; }
    #sendBtn { background:#668cff; border:none; color:#fff; padding:0.5rem 1rem; border-radius:0.4rem; font-size:1rem; cursor:pointer; }
    #sendBtn:disabled { opacity:0.6; cursor:default; }
    #numpad { display:grid; grid-template-columns:repeat(4,1fr); gap:0.5rem; }
    #numpad button { background:#668cff; border:none; color:#fff; padding:0.6rem; border-radius:0.4rem; font-size:1.2rem; cursor:pointer; }
    #quizTimer { width:100%; text-align:center; font-weight:bold; margin:16px 0 0; align-self:center; }
    /* Panels */
    #settingsPanel,#resultsPanel,#timeUpPanel,#startPanel { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:100; }
    /* ... (other panel-specific styles unchanged) ... */
    @media(max-width:600px){ #quizPanel{width:100vw;max-width:100vw;min-width:0;padding:.7rem;} #qText,.full-question-text,.flash-center{font-size:2.1rem!important;} .results-card{width:97vw;} #startPanel .start-card{width:99vw;} }
  </style>
</head>
<body>
  <div id="startPanel">
    <div class="start-card">
      <div class="abacus-mascot">
        <div class="abacus-body">
          <div class="abacus-rod"></div>
          <div class="abacus-beads">
            <div class="abacus-bead"></div><div class="abacus-bead"></div><div class="abacus-bead"></div><div class="abacus-bead"></div>
          </div>
          <div class="abacus-rod"></div>
        </div>
        <div class="abacus-face"></div>
      </div>
      <div class="start-title">Soroban Quiz!</div>
      <button class="start-btn" id="startQuizBtn">Start Quiz!</button>
      <button class="start-settings-btn" id="startSettingsBtn">Settings ⚙️</button>
      <div class="confetti" id="confettiBox"></div>
    </div>
  </div>
  <div id="abacusRoot"><div class="soroban" id="sorobanBoard"></div></div>
  <div id="quizPanel">
    <div id="topBtns"><button id="settingsBtn">⚙️</button><button id="resetBtn">↻</button><button id="fullscreenBtn">⛶</button></div>
    <div id="quizContent">
      <div class="question"><div id="qNum">Q1</div><div id="qText"></div></div>
      <div><div class="input-label">Your Answer</div><div class="inputArea"><div id="answerDisplay">0</div><button id="sendBtn" disabled>Send</button></div></div>
      <div id="numpad"></div>
      <div id="quizTimer">Time Left: 10:00</div>
    </div>
  </div>
  <div id="settingsPanel"><div class="settings-card">...settings markup...</div></div>
  <div id="resultsPanel"><div class="results-card">...results markup...</div></div>
  <div id="timeUpPanel"><div class="timeup-card">...time-up markup...</div></div>
  <audio id="soundOn" src="abacus sound effect 1.wav"></audio>
  <audio id="soundOff" src="abacus sound effect 2.wav"></audio>
  <audio id="tickSound" src="tick.wav"></audio>
  <script>
    // Utility
    const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
    // Confetti
    function launchConfetti(){ const conf=document.getElementById('confettiBox');conf.innerHTML='';const colors=['#ffd700','#b993d6','#4d79ff','#66e6ff','#ffb3e6','#ff7878','#c8ffb0'];for(let i=0;i<36;i++){let el=document.createElement('span');el.style.left=(Math.random()*96+2)+'%';el.style.background=colors[Math.floor(Math.random()*colors.length)];el.style.animationDuration=(1.1+Math.random()*0.5)+'s';el.style.opacity=0.82+Math.random()*0.18;el.style.transform=`rotate(${Math.random()*360}deg)`;conf.appendChild(el);}setTimeout(()=>{conf.innerHTML='';},1600);}    
    // Abacus creation
    const board=$('#sorobanBoard');function createRod(){const r=document.createElement('div');r.className='rod';r.innerHTML="<div class='rod-line'></div><div class='heaven'><div class='bead heaven'></div></div><div class='gap-space'></div><div class='earth'>"+'<div class=\"bead earth\"></div>'.repeat(4)+"</div><div class='bar'></div>";return r;}for(let i=0;i<8;i++)board.appendChild(createRod());
    function clearBoard(){$$('.bead.active').forEach(b=>b.classList.remove('active'));}
    $('#resetBtn').onclick=clearBoard;
    function setBead(b,active){const hv=b.classList.contains('heaven'),cs=[...b.parentElement.children],idx=cs.indexOf(b);if(hv)b.classList.toggle('active',active);else cs.forEach((e,i)=>e.classList.toggle('active',active?i<=idx:i<idx));navigator.vibrate(12);if(!mute){if(active)$('#soundOn').play();else $('#soundOff').play();}}
    $$('.bead').forEach(b=>b.addEventListener('pointerdown',e=>{const rg=b.classList.contains('heaven')?'heaven':'earth',sy=e.clientY;b.setPointerCapture(e.pointerId);b.onpointermove=ev=>{let dy=ev.clientY-sy;if(Math.abs(dy)>10){setBead(b,rg==='heaven'?dy>0:dy<0);b.onpointermove=null;}};b.onpointerup=b.onpointercancel=()=>{b.onpointermove=null;b.releasePointerCapture(e.pointerId);};}));
    if(window.DeviceMotionEvent){let last=0;window.addEventListener('devicemotion',e=>{const{ x,y,z }=e.accelerationIncludingGravity,mag=Math.hypot(x,y,z),now=performance.now();if(mag>16&&now-last>750){clearBoard();last=now;}});}    
    // Quiz state
    let numQuestions=10, flashSpeed=1, flashEnabled=true, timerMinutes=10;
    let QUESTIONS=[],currentIndex=0,answers=[],currentInput='',inputLocked=false,timerInterval,timeLeft=600,flashTimer=null,mute=false;
    const qNumEl=$('#qNum'),qTextEl=$('#qText'),answerEl=$('#answerDisplay'),sendBtnEl=$('#sendBtn'),timerEl=$('#quizTimer'),padEl=$('#numpad');
    const settingsBtn=$('#settingsBtn'),settingsPanel=$('#settingsPanel'),numQInput=$('#numQuestions'),flashToggle=$('#flashToggle'),flashSpeedSel=$('#flashSpeedSec'),timerSel=$('#timerSelect'),muteInput=$('#muteSound');
    // Build numpad & timer select
    ['0','1','2','3','4','5','6','7','8','9','C','BACK'].forEach(d=>{let b=document.createElement('button');b.textContent=d==='BACK'?'⌫':d;b.onclick=()=>appendDigit(d);padEl.appendChild(b);});
    for(let i=1;i<=10;i++){let o=new Option(i,i);if(i===10)o.selected=true;timerSel.add(o);}    
    // Flash tokens
    function parseQuestionToTokens(q){let arr=q.split(/([+-])/).map(s=>s.trim()).filter(Boolean),tokens=[{type:'first',val:arr[0]}];for(let i=1;i<arr.length;i+=2)tokens.push({type:'op',op:arr[i],val:arr[i+1]});return tokens;}
    function flashQuestionTokens(qstr,cb){if(flashTimer)clearTimeout(flashTimer);let tokens=parseQuestionToTokens(qstr),idx=0; qTextEl.innerHTML='';let center=document.createElement('div');center.className='flash-center';qTextEl.appendChild(center);inputLocked=true;sendBtnEl.disabled=true;
      function showNext(){center.innerHTML='';if(idx<tokens.length){let html='';if(tokens[idx].type==='first')html=tokens[idx].val;else{let highlight=false;if(idx>1){let prev=tokens[idx-1];if(prev.type==='op'&&prev.op===tokens[idx].op&&prev.val===tokens[idx].val)highlight=true;}html=`<span class="${highlight?'diff-op':''}">${tokens[idx].op}</span> <span class="${highlight?'diff-num':''}">${tokens[idx].val}</span>`;if(idx===tokens.length-1)html+=`<span class="qmark">?</span>`;}center.innerHTML=html;if(!mute){$('#tickSound').currentTime=0;$('#tickSound').play();} if(idx===tokens.length-1){flashTimer=setTimeout(()=>{qTextEl.innerHTML=`<span class="full-question-text">${qstr} <span class="qmark">?</span></span>`;inputLocked=false;sendBtnEl.disabled=(currentInput==='');cb&&cb();},flashSpeed*1000);} else{flashTimer=setTimeout(()=>{idx++;showNext();},flashSpeed*1000);} }} showNext();}
    // Input & navigation
    function appendDigit(d){if(inputLocked)return; if(d==='C')currentInput=''; else if(d==='BACK')currentInput=currentInput.slice(0,-1); else currentInput+=d; answerEl.textContent=currentInput||'0'; sendBtnEl.disabled=currentInput.length===0;}
    sendBtnEl.onclick=submitAnswer; answerEl.onclick=submitAnswer;
    function loadQuestion(){const q=QUESTIONS[currentIndex];qNumEl.textContent='Q'+(currentIndex+1);currentInput='';answerEl.textContent='0';inputLocked=true;sendBtnEl.disabled=true;if(flashEnabled)flashQuestionTokens(q.q,()=>{inputLocked=false;sendBtnEl.disabled=(currentInput==='');});else{qTextEl.innerHTML=`<span class="full-question-text">${q.q} <span class="qmark">?</span></span>`;inputLocked=false;sendBtnEl.disabled=(currentInput==='');}}
    function updateTimer(){let m=String(Math.floor(timeLeft/60)).padStart(2,'0'),s=String(timeLeft%60).padStart(2,'0');timerEl.textContent=`Time Left: ${m}:${s}`;}
    function submitAnswer(){if(inputLocked||currentInput==='')return;inputLocked=true;answers.push({question:QUESTIONS[currentIndex].q,correct:QUESTIONS[currentIndex].a,user:currentInput});if(currentIndex<QUESTIONS.length-1){setTimeout(()=>{currentIndex++;loadQuestion();},350);}else showResults();}
    // Results & panels
    function showResults(){clearInterval(timerInterval);$('#quizPanel').style.display='none';$('#resultsPanel').style.display='flex';const rl=$('#resultsList'),rs=$('#resultScore');rl.innerHTML='';let sc=0;answers.forEach((a,i)=>{let cor=a.user===a.correct;if(cor)sc++;let di=document.createElement('div');di.className='result-item';di.innerHTML=`<div class="question-text">Q${i+1}: ${a.question}</div><div class="your-answer"><span class="mark">${cor?'✔️':'❌'}</span><span>Your: ${a.user}</span></div>${!cor?`<div class='correct-answer'>Correct: ${a.correct}</div>`:''}`;rl.appendChild(di);});rs.textContent=`You scored ${sc}/${answers.length}`;}
    $('#tryAgainBtn').onclick=startQuiz;$('#tryAgainTimeUpBtn').onclick=startQuiz;
    function showTimeUp(){clearInterval(timerInterval);$('#quizPanel').style.display='none';$('#timeUpPanel').style.display='flex';}
    // Question generators
    function randomChapter1(numQuestions=10){const out=[];function r15(){return Math.floor(Math.random()*5)+1;}function rOp(){return Math.random()<0.5?'+':'-';}function evalOp(x,o,y){return o==='+'?x+y:x-y;}while(out.length<numQuestions){const A=r15(),B=r15(),C=r15(),op1=rOp();if(A===5&&op1==='-'&&B!==5)continue;if(A===5&&op1==='+'&&B===5)continue;if(A===4&&(op1==='-'&&!(B>=1&&B<=4)))continue;if(A===4&&(op1==='+'&&B!==5))continue;if(A<=4&&Math.abs(evalOp(A,op1,B))>4)continue;const AB=evalOp(A,op1,B);if(AB<0||AB>9)continue;if(AB===5)continue;let op2=(AB===0)?'+':rOp();if(AB===4&&C!==5)continue;if(A===5&&op2==='+'&&!(AB+C>=5&&AB+C<=9))continue;if(A===5&&op2==='-'&&!(B>C))continue;const D=evalOp(AB,op2,C);if(D<0||D>9||D===5)continue;if(AB<4&&!(D<4||C===5))continue;if(A+B===5||A+C===5||B+C===5)continue;out.push({q:`${A} ${op1} ${B} ${op2} ${C}`,a:D.toString()});}return out;}
    function randomChapter2(numQuestions=10){const out=[];function r19(){return Math.floor(Math.random()*9)+1;}function rOp(){return Math.random()<0.5?'+':'-';}function evalOp(x,o,y){return o==='+'?x+y:x-y;}function choose(gen,ok,tries=60){while(tries--){const v=gen();if(ok(v))return v;}return null;}function validB_plus(A,B){if(A<=4)return!(B>=10-A||(B>=5-A&&B<5));if(A===5)return B<5;return B<10-A;}function validB_minus(A,B){if(A<=4)return B<=A;if(A===5)return B===5;return B<=A-5||B===5;}function validC_plusplus(S,C){if(S<=4)return!(C>=10-S||(C>=5-S&&C<5));if(S===5)return C<5;return C<10-S;}function validC_plusminus(S,C){if(2<=S&&S<=4)return C<S;if(S===5)return C===5;return C<=S-5||C===5;}function validC_minusplus(S,C){if(S<=4)return!(C>=10-S||(C>=5-S&&C<5));if(S===5)return C<5;return C<10-S;}function validC_minusminus(S,C){if(S<=4)return C<S;if(S===5)return C===5;return C<=S-5||C===5;}while(out.length<numQuestions){const A=r19(),op1=rOp();let B=choose(r19,b=>op1==='+'?validB_plus(A,b):validB_minus(A,b));if(B==null)continue;const stage1=evalOp(A,op1,B);if(stage1<0||stage1>9)continue;const op2=rOp();let C=choose(r19,c=>{if(op1==='+'&&op2==='+')return validC_plusplus(stage1,c);if(op1==='+'&&op2==='-')return validC_plusminus(stage1,c);if(op1==='-'&&op2==='+')return validC_minusplus(stage1,c);return validC_minusminus(stage1,c);} );if(C==null)continue;const D=evalOp(stage1,op2,C);if(D<0||D>9)continue;out.push({q:`${A} ${op1} ${B} ${op2} ${C}`,a:D.toString()});}return out;}
    function randomChapter3(numQuestions=10){const out=[];while(out.length<numQuestions){const op1=Math.random()<0.5?'+':'-',op2=Math.random()<0.5?'+':'-';let A,B,C;if(op1==='+'){A=Math.floor(Math.random()*4)+1;const pivot=5-A;switch(Math.floor(Math.random()*6)+1){case 1:B=pivot;C=op2==='+'?Math.floor(Math.random()*4)+1:5;break;case 2:if(pivot<=1||op2!=='+' )continue;B=Math.floor(Math.random()*(pivot-1))+1;C=5-(A+B);break;case 3:if(pivot>=5||op2!=='+' )continue;B=Math.floor(Math.random()*(5-pivot))+(pivot+1);C=Math.floor(Math.random()*(A+B-1))+1;break;case 4:if(op2!=='-')continue;B=pivot;C=5;break;case 5:if(pivot<=1||op2!=='-')continue;B=Math.floor(Math.random()*(pivot-1))+1;C=Math.floor(Math.random()*(A+B))+1;break;case 6:if(pivot>=5||op2!=='-')continue;B=Math.floor(Math.random()*(5-pivot))+(pivot+1);C=[(A+B)-5,5][Math.random()<0.5?0:1];break;} }else{A=Math.floor(Math.random()*9)+1;if(A<=4){if(A<=1||op2!=='+' )continue;B=Math.floor(Math.random()*(A-1))+1;C=5-(A-B);}else if(A>=6&&A<=9){if(op2!=='+' )continue;if(Math.random()<0.5&&A-5>=1){B=Math.floor(Math.random()*(A-5))+1;C=Math.floor(Math.random()*4)+1;}else{B=5;C=5-(A-B);} }else continue;}const stage1=op1==='+'?A+B:A-B,D=op2==='+'?stage1+C:stage1-C;if(D<0||D>9)continue;out.push({q:`${A} ${op1} ${B} ${op2} ${C}`,a:D.toString()});}return out;}
    // Start & settings
    function showStartPanel(){$('#startPanel').style.display='flex';$('#quizPanel').style.display='none';$('#resultsPanel').style.display='none';$('#timeUpPanel').style.display='none';}
    function hideStartPanel(){$('#startPanel').style.display='none';}
    $('#startQuizBtn').onclick=()=>{hideStartPanel();setTimeout(launchConfetti,100);startQuiz();};
    $('#startSettingsBtn').onclick=()=>settingsPanel.style.display='flex';
    settingsBtn.onclick=()=>{settingsPanel.style.display='flex';numQInput.value=numQuestions;flashSpeedSel.value=flashSpeed;flashToggle.checked=flashEnabled;timerSel.value=timerMinutes;muteInput.checked=mute;};
    $('#cancelSettings').onclick=()=>settingsPanel.style.display='none';
    $('#saveSettings').onclick=()=>{numQuestions=Math.max(1,Math.min(50,Number(numQInput.value)));flashSpeed=Math.max(1,Math.min(5,Number(flashSpeedSel.value)));flashEnabled=flashToggle.checked;timerMinutes=Math.max(1,Math.min(10,Number(timerSel.value)));mute=muteInput.checked;settingsPanel.style.display='none';};
    // Quiz start
    function startQuiz(){if(flashTimer)clearTimeout(flashTimer);currentIndex=0;answers=[];currentInput='';inputLocked=true;timeLeft=timerMinutes*60;$('#quizPanel').style.display='flex';$('#resultsPanel').style.display='none';$('#timeUpPanel').style.display='none';const chap=parseInt(new URL(location.href).searchParams.get('chapter')||'1',10);if(chap>=3){QUESTIONS=randomChapter3(numQuestions);}else if(chap>=2){QUESTIONS=randomChapter2(numQuestions);}else{QUESTIONS=randomChapter1(numQuestions);}loadQuestion();updateTimer();if(timerInterval)clearInterval(timerInterval);timerInterval=setInterval(()=>{timeLeft--;updateTimer();if(timeLeft<=0){clearInterval(timerInterval);showTimeUp();}},1000);}    
    $('#fullscreenBtn').onclick=()=>document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();
    $('#fullscreenBtnResults').onclick=$('#fullscreenBtn').onclick;
    $('#fullscreenBtnTimeUp').onclick=$('#fullscreenBtn').onclick;
    // Init
    showStartPanel();
  </script>
</body>
</html>
